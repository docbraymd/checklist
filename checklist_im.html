<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>IM Residency Program Evaluation & Selection 2025-2026</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <style>
        /* --- Base Styles & Theme --- */
        :root {
            --bg-main: #1a1a2e;
            --bg-secondary: #16213e;
            --bg-container: #0f0f1e;
            --bg-element: #252535;
            --bg-element-hover: #2a2a40;
            --text-primary: #e0e0e0;
            --text-secondary: #b0b0b0;
            --accent-blue: #00d9ff;
            --accent-yellow: #ffd93b;
            --accent-green: #00ff88;
            --border-color: #2a5298;
            --border-ui: #2a2a3e;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, var(--bg-main) 0%, var(--bg-secondary) 100%);
            color: var(--text-primary);
            line-height: 1.6;
            padding: 20px;
            min-height: 100vh;
            /* Padding top to ensure content doesn't hide behind the fixed score header */
            padding-top: 80px; 
        }

        .container {
            max-width: 1300px;
            margin: 0 auto;
            background: var(--bg-container);
            border-radius: 15px;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.5);
            overflow: hidden;
        }

        @media (max-width: 768px) {
            body {
                padding: 0;
                padding-top: 70px;
            }
            .container {
                border-radius: 0;
            }
        }

        /* --- Header --- */
        .header {
            background: linear-gradient(135deg, #1e3a5f 0%, var(--border-color) 100%);
            padding: 30px;
            text-align: center;
            border-bottom: 3px solid var(--accent-blue);
        }

        .header h1 {
            color: var(--accent-blue);
            font-size: 2.5em;
            margin-bottom: 10px;
            text-shadow: 0 0 20px rgba(0, 217, 255, 0.5);
        }

        .header p {
            color: var(--text-secondary);
            font-size: 1.1em;
        }

        /* --- Program Details Input --- */
        .program-details {
            background: var(--bg-main);
            padding: 20px 30px;
            display: flex;
            gap: 20px;
            flex-wrap: wrap;
            justify-content: center;
            border-bottom: 2px solid var(--border-ui);
        }

        .input-group {
            display: flex;
            flex-direction: column;
            gap: 5px;
        }

        .input-group label {
            color: var(--accent-blue);
            font-weight: 600;
        }

        .input-group input {
            padding: 10px 15px;
            border-radius: 8px;
            border: 1px solid var(--border-color);
            background: var(--bg-container);
            color: var(--text-primary);
            font-size: 1em;
            min-width: 250px;
        }

        .input-group input:focus {
            outline: none;
            border-color: var(--accent-blue);
            box-shadow: 0 0 10px rgba(0, 217, 255, 0.3);
        }

        /* --- Info Box & Rating Guide --- */
        .info-box {
            background: var(--bg-element);
            padding: 20px;
            margin: 20px 30px;
            border-radius: 10px;
            border-left: 4px solid var(--accent-yellow);
        }

        .info-box h3 {
            color: var(--accent-yellow);
            margin-bottom: 10px;
        }

        .info-box p {
            color: var(--text-secondary);
            font-size: 0.95em;
            margin-bottom: 8px;
        }

        .rating-guide {
            display: inline-flex;
            gap: 10px;
            margin-top: 10px;
            flex-wrap: wrap;
        }

        .rating-guide span {
            background: var(--bg-main);
            padding: 5px 12px;
            border-radius: 5px;
            font-size: 0.85em;
        }

        /* --- Controls & Buttons --- */
        .controls {
            background: var(--bg-main);
            padding: 20px 30px;
            display: flex;
            gap: 15px;
            flex-wrap: wrap;
            justify-content: center;
            align-items: center;
        }

        .controls.top-controls {
            border-bottom: 2px solid var(--border-ui);
        }

        .controls.bottom-controls {
            border-top: 2px solid var(--border-ui);
        }


        .btn {
            padding: 12px 24px;
            border: none;
            border-radius: 8px;
            font-size: 1em;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            text-transform: uppercase;
            letter-spacing: 1px;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.3);
        }

        .btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none !important;
        }

        /* Button Gradients (Restored from original request) */
        .btn-primary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: #ffffff;
        }

        .btn-primary:hover:not(:disabled) {
            background: linear-gradient(135deg, #764ba2 0%, #667eea 100%);
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(102, 126, 234, 0.5);
        }

        .btn-primary.top-ten {
            background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
        }

        .btn-primary.top-ten:hover:not(:disabled) {
            background: linear-gradient(135deg, #f5576c 0%, #f093fb 100%);
            box-shadow: 0 8px 25px rgba(245, 87, 108, 0.5);
        }

        .btn-success {
            background: linear-gradient(135deg, #11998e 0%, #38ef7d 100%);
            color: #ffffff;
        }

        .btn-success:hover:not(:disabled) {
            background: linear-gradient(135deg, #38ef7d 0%, #11998e 100%);
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(56, 239, 125, 0.5);
        }

        .btn-warning {
            background: linear-gradient(135deg, #fc6c8f 0%, #ffb88c 100%);
            color: #ffffff;
        }

        .btn-warning:hover:not(:disabled) {
            background: linear-gradient(135deg, #ffb88c 0%, #fc6c8f 100%);
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(252, 108, 143, 0.5);
        }

        /* Specific Export Button Styles */
        .btn-success.excel {
            background: linear-gradient(135deg, #1e7e34 0%, #28a745 100%);
        }

        .btn-success.excel:hover:not(:disabled) {
            background: linear-gradient(135deg, #28a745 0%, #1e7e34 100%);
            box-shadow: 0 8px 25px rgba(40, 167, 69, 0.5);
        }

        .btn-success.csv {
            background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
        }

        .btn-success.csv:hover:not(:disabled) {
            background: linear-gradient(135deg, #00f2fe 0%, #4facfe 100%);
            box-shadow: 0 8px 25px rgba(79, 172, 254, 0.5);
        }

        .btn-warning.pdf {
            background: linear-gradient(135deg, #fa709a 0%, #fee140 100%);
        }

        .btn-warning.pdf:hover:not(:disabled) {
            background: linear-gradient(135deg, #fee140 0%, #fa709a 100%);
            box-shadow: 0 8px 25px rgba(254, 225, 64, 0.5);
        }
        
        .btn-danger {
            background: linear-gradient(135deg, #eb3349 0%, #f45c43 100%);
            color: #ffffff;
        }

        .btn-danger:hover:not(:disabled) {
            background: linear-gradient(135deg, #f45c43 0%, #eb3349 100%);
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(235, 51, 73, 0.5);
        }

        /* --- Content & Categories --- */
        .content {
            padding: 30px;
        }

        .category {
            margin-bottom: 30px;
            background: var(--bg-main);
            border-radius: 10px;
            padding: 20px;
            border-left: 4px solid var(--accent-blue);
            transition: all 0.3s ease;
        }

        .category:hover {
            background: #1e1e2e;
            box-shadow: 0 5px 20px rgba(0, 217, 255, 0.1);
        }

        .category-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
            cursor: pointer;
            padding: 10px;
            border-radius: 8px;
            transition: background 0.3s ease;
        }

        .category-header:hover {
            background: var(--bg-element);
        }

        .category-title {
            font-size: 1.4em;
            font-weight: 700;
            color: var(--accent-blue);
            text-shadow: 0 0 10px rgba(0, 217, 255, 0.3);
        }

        .category-count {
            background: var(--accent-blue);
            color: var(--bg-container);
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 0.9em;
            font-weight: 600;
        }

        .category-items {
            display: block;
        }

        .category-items.collapsed {
            display: none;
        }

        .toggle-icon {
            font-size: 1.2em;
            transition: transform 0.3s ease;
        }

        .toggle-icon.collapsed {
            transform: rotate(-90deg);
        }

        /* --- Checklist Item, Selection & Rating Controls --- */
        .checklist-item {
            display: flex;
            align-items: center; /* Vertically center checkbox, label, and rating */
            padding: 15px;
            background: var(--bg-element);
            border-radius: 6px;
            margin-bottom: 10px;
            transition: all 0.2s ease;
        }

        .checklist-item:hover {
            background: var(--bg-element-hover);
        }

        /* Selection Checkbox (Restored) */
        .checklist-item input[type="checkbox"] {
            margin-right: 15px;
            width: 20px;
            height: 20px;
            cursor: pointer;
            accent-color: var(--accent-blue);
            flex-shrink: 0; /* Prevent checkbox from shrinking */
        }

        .item-label {
            flex: 1;
            color: #d0d0d0;
            font-size: 0.95em;
            padding-right: 20px;
            cursor: pointer; /* Make label clickable */
        }

        /* Visual feedback for selected items */
        .checklist-item.selected {
            background: #2a3a4a; /* Darker background for selected */
            border-left: 3px solid var(--accent-green);
        }

        .checklist-item.selected .item-label {
             color: var(--accent-green);
             font-weight: 500;
        }

        /* Rating Controls */
        .rating-container {
            display: flex;
            align-items: center;
            gap: 15px;
            flex-shrink: 0; /* Prevent rating controls from shrinking */
        }

        /* Style for disabled rating container (when checkbox is unchecked) */
        .rating-container.disabled {
            opacity: 0.4;
            pointer-events: none; /* Prevents interaction with inputs/sliders */
        }

        .slider-container {
            width: 120px;
            transition: opacity 0.3s ease, visibility 0.3s ease, width 0.3s ease;
        }

        /* Hide slider by default (unscored state) */
        .rating-container.unscored .slider-container {
            opacity: 0;
            visibility: hidden;
            width: 0;
            margin-right: -15px; /* Compensate for the gap when hidden */
        }

        .rating-slider {
            width: 100%;
            cursor: pointer;
            accent-color: var(--accent-blue);
        }

        .rating-input {
            width: 60px;
            padding: 8px;
            text-align: center;
            border-radius: 5px;
            border: 1px solid var(--border-color);
            background: var(--bg-container);
            color: var(--text-primary);
            font-size: 1em;
            cursor: pointer;
        }

        /* Style for unscored input */
        .rating-container.unscored .rating-input {
            color: #7a7a8e;
            font-style: italic;
        }
        
        /* Style for scored input */
        .rating-container:not(.unscored) .rating-input {
            color: var(--accent-green);
            font-weight: bold;
            border-color: var(--accent-green);
            cursor: text;
        }

        .rating-input:focus {
            outline: none;
            border-color: var(--accent-blue);
            box-shadow: 0 0 5px rgba(0, 217, 255, 0.5);
        }

        /* --- Filtering (Restored) --- */
        /* Hide unselected items when filter is active */
        .filter-active .checklist-item:not(.selected) {
            display: none;
        }

        /* Hide empty categories when filter is active */
        .filter-active .category:not(.has-selected) {
            display: none;
        }

        /* --- Sticky Score Display --- */
        .sticky-score-header {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            background: var(--bg-main);
            padding: 15px 30px;
            box-shadow: 0 5px 20px rgba(0, 0, 0, 0.6);
            z-index: 100;
            display: flex;
            justify-content: center;
            align-items: center;
            border-bottom: 2px solid var(--accent-blue);
        }

        .score-display {
            font-size: 1.2em;
            color: var(--text-secondary);
        }

        .score-value {
            color: var(--accent-green);
            font-size: 1.4em;
            font-weight: 700;
            margin-left: 10px;
            text-shadow: 0 0 10px rgba(0, 255, 136, 0.5);
        }

        .score-details {
            font-size: 0.8em;
            color: #9a9aae;
            margin-left: 15px;
        }

        /* --- Narrative Comments --- */
        .narrative-section {
            padding: 30px;
            background: var(--bg-main);
            margin: 0 30px 30px 30px;
            border-radius: 10px;
            border-left: 4px solid var(--accent-yellow);
        }

        .narrative-section h3 {
            color: var(--accent-yellow);
            margin-bottom: 10px;
        }

        .narrative-section p {
            color: var(--text-secondary);
            font-size: 0.9em;
            margin-bottom: 15px;
        }

        #narrativeComments {
            width: 100%;
            min-height: 150px;
            padding: 15px;
            border-radius: 8px;
            border: 1px solid var(--border-color);
            background: var(--bg-container);
            color: var(--text-primary);
            font-size: 1em;
            resize: vertical;
        }

        #narrativeComments:focus {
            outline: none;
            border-color: var(--accent-blue);
            box-shadow: 0 0 10px rgba(0, 217, 255, 0.3);
        }

        /* --- Footer & Copyright --- */
        .footer {
            text-align: center;
            padding: 20px;
            background: var(--bg-container);
            color: #7a7a8e;
            font-size: 0.9em;
            border-top: 1px solid var(--border-ui);
        }

        /* --- Utilities & Misc --- */
        ::-webkit-scrollbar {
            width: 10px;
            height: 10px;
        }

        ::-webkit-scrollbar-track {
            background: var(--bg-main);
        }

        ::-webkit-scrollbar-thumb {
            background: var(--accent-blue);
            border-radius: 5px;
        }

        ::-webkit-scrollbar-thumb:hover {
            background: #00fff2;
        }

        /* Toast notification */
        .toast {
            position: fixed;
            bottom: 30px;
            right: 30px;
            background: linear-gradient(135deg, #51cf66 0%, #37b24d 100%);
            color: white;
            padding: 15px 25px;
            border-radius: 10px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
            transform: translateY(150%);
            transition: transform 0.3s ease;
            z-index: 1000;
            font-weight: 600;
        }

        .toast.show {
            transform: translateY(0);
        }

        .toast.error {
            background: linear-gradient(135deg, #ff6b6b 0%, #fa5252 100%);
        }
    </style>
</head>
<body>
    <div class="sticky-score-header">
        <div class="score-display">
            Summative Score: <span class="score-value" id="summativeScore">0</span>
            <span class="score-details">(<span id="scoredCount">0</span> rated / <span id="selectedCount">0</span> selected / <span id="totalCount">0</span> total)</span>
        </div>
    </div>

    <div class="container">
        <div class="header">
            <h1>🏥 Internal Medicine Residency Program Evaluation</h1>
            <p>2025-2026 Application Cycle • Criteria Selection & Post-Interview Assessment</p>
        </div>

        <div class="program-details">
            <div class="input-group">
                <label for="programName">Program Name</label>
                <input type="text" id="programName" placeholder="e.g., University Hospital IM">
            </div>
            <div class="input-group">
                <label for="interviewDate">Interview Date</label>
                <input type="date" id="interviewDate">
            </div>
        </div>

        <div class="info-box">
            <h3>📝 How to Use This Tool</h3>
            <p><strong>1. Select Criteria:</strong> Check the boxes for criteria important to YOU. Use the preset buttons (Top 10/25) for a quick start. Rating is enabled only for selected items.</p>
            <p><strong>2. Rate the Program:</strong> For selected criteria, click the score field ("--") to activate the rating (defaults to 3). Adjust the slider or type (1-5).</p>
            <div class="rating-guide">
                <span>1 = Poor</span>
                <span>2 = Below Average</span>
                <span>3 = Average</span>
                <span>4 = Good</span>
                <span>5 = Excellent</span>
            </div>
            <p style="margin-top: 10px;"><strong>✓ Complete within 24 hours</strong> of your interview to capture fresh impressions.</p>
        </div>

        <div class="controls top-controls">
            <button class="btn btn-primary" onclick="selectTop25()">⭐ Select Top 25 Most Common</button>
            <button class="btn btn-primary top-ten" onclick="selectTopTen()">⚡ Select Top 10 Essential</button>
            <button class="btn btn-success" onclick="selectAll()">✓ Select All Criteria</button>
            <button class="btn btn-danger" onclick="deselectAll()">✗ Deselect All</button>
            <button class="btn btn-warning" onclick="toggleFilter()" id="filterBtn">👁️ Hide Unselected</button>
        </div>

        <div class="content">
            <div id="checklistPanel"></div>
        </div>

        <div class="narrative-section">
            <h3>💬 Narrative Comments</h3>
            <p>Record your first memories, gut reactions, and key takeaways from the interview day (within the first 24 hours).</p>
            <textarea id="narrativeComments" placeholder="Enter your immediate thoughts and feelings here..."></textarea>
        </div>

        <div class="controls bottom-controls">
            <button class="btn btn-success excel" onclick="exportToExcel()" id="excelBtn">📊 Export to Excel</button>
            <button class="btn btn-success csv" onclick="exportToCSV()" id="csvBtn">📄 Export to CSV</button>
            <button class="btn btn-warning pdf" onclick="exportToPDF()" id="pdfBtn">📑 Save as PDF</button>
            <button class="btn btn-danger" onclick="resetForm()">🔄 Reset Form</button>
        </div>

        <div class="footer">
            © 2025 DocBray Foundation. All rights reserved.
        </div>
    </div>

    <div id="toast" class="toast"></div>

    <script>
        // Complete dataset of criteria
        const checklistData = {
            "Education & Curriculum": [
                "Program philosophy and mission alignment",
                "ACGME accreditation status (no recent citations)",
                "Overall curriculum quality and structure",
                "Rotations and electives variety (exposure to subspecialties)",
                "Educational rounds vs. work rounds balance",
                "Conference quality (morning report, noon conference, grand rounds)",
                "Patient volume and diversity (socioeconomic, ethnic backgrounds)",
                "Library and educational resources access",
                "Resident evaluation methods (milestones, direct observation, feedback frequency)",
                "Board certification pass rates for graduates (>80% ACGME minimum; >90% excellent)",
                "Continuity clinic model (weekly vs. block vs. X+Y)",
                "Continuity clinic frequency (meets 10-month outpatient requirement)",
                "Post-call clinic policies",
                "Protected time for conferences and education",
                "MKSAP subscription and board preparation support",
                "In-Training Examination (ITE) administration and feedback",
                "Simulation-based training availability",
                "Point-of-care ultrasound (POCUS) training",
                "Procedure training structure and competency assessment"
            ],
            "Faculty & Teaching": [
                "Full-time vs. part-time faculty ratio",
                "Research vs. teaching balance among faculty",
                "Clinical and teaching skills of faculty",
                "Faculty availability and approachability",
                "Continuity clinic preceptors (longitudinal relationship)",
                "Subspecialties represented (strong in areas of interest?)",
                "Faculty involvement in patient counseling and education",
                "Attending rounds frequency (2-3x weekly minimum on inpatient)",
                "Bedside teaching vs. 'see and present' culture",
                "Faculty-to-resident ratio",
                "Faculty turnover rate",
                "Faculty development in teaching",
                "Program director accessibility and responsiveness",
                "Associate/assistant program director support",
                "Chief resident accessibility and mentorship"
            ],
            "Hospital & Facilities": [
                "Community vs. university hospital setting",
                "Staff support for program (nursing, labs, pathology, respiratory)",
                "Consultative services availability and quality",
                "Other residency programs present at training sites",
                "Patient types and disease diversity",
                "Patient socioeconomic and ethnic diversity",
                "Hospital staff quality (nursing, support services)",
                "Primary training site reputation",
                "Number of different rotation sites",
                "Distance and commute between sites",
                "VA hospital rotations (if applicable)",
                "EMR system consistency across sites (Epic, Cerner, etc.)",
                "EMR user-friendliness",
                "Telemedicine infrastructure",
                "Call room quality and cleanliness",
                "Call room privacy (individual vs. shared)",
                "Resident lounge and workspace adequacy",
                "Hospital cafeteria hours and quality",
                "Hospital gym availability and quality"
            ],
            "Residents & Program Culture": [
                "Number of residents per year",
                "Medical schools of origin (diversity)",
                "Resident personality, dependability, and honesty",
                "Cooperativeness and compatibility among residents",
                "Do residents socialize outside of work?",
                "Collaborative vs. competitive environment",
                "Support among co-residents (coverage culture)",
                "Resident morale and happiness",
                "Would residents choose program again?",
                "Resident retention rate (>98% excellent for IM)",
                "Attrition rate (<2% excellent; >3% concerning)",
                "Resident enthusiasm and energy during interview",
                "Residents appearing rested vs. exhausted",
                "Interprofessional respect (with nurses, APPs, etc.)",
                "Professionalism and mutual respect",
                "Program responsiveness to resident concerns"
            ],
            "Workload & Duty Hours": [
                "Average patients per resident (rotation and clinic)",
                "Supervision levels and attending support",
                "Call schedule type (night float, 24-hour, hybrid)",
                "Call schedule frequency (Q3, Q4, Q5, etc.)",
                "Rounds and teaching responsibilities",
                "Scut work balance (phlebotomy, transport, etc.)",
                "Time protected for conferences and clinics",
                "Progressive autonomy from PGY1 to PGY3",
                "Actual work hours vs. stated policy (<80 hours/week)",
                "Duty hour violation frequency and handling",
                "Culture around staying beyond scheduled hours",
                "Post-call policies (time off after overnight)",
                "Night float duration and frequency",
                "Post-night float recovery days",
                "Weekend coverage frequency",
                "Home call frequency and burden",
                "Ancillary support (phlebotomy, social work, respiratory therapy)"
            ],
            "Benefits & Wellness": [
                "Salary for PGY-1, PGY-2, PGY-3",
                "Professional dues, meals, and insurance coverage",
                "Health insurance quality and employee contribution",
                "Dental and vision coverage",
                "Mental health coverage quality",
                "Vacation, parental leave, maternity, sick leave policies",
                "Parental leave duration (6+ weeks minimum; 12+ ideal)",
                "Policy for birthing vs. non-birthing parents",
                "Adoption and foster care leave",
                "Conference funding and educational stipend",
                "Books and MKSAP subscription provided",
                "Moonlighting permitted (internal and/or external)",
                "Year eligible for moonlighting and pay rates",
                "Stress management support and wellness programs",
                "24/7 confidential mental health access",
                "Wellness curriculum and wellness committee",
                "Regular burnout assessment with action plans",
                "Protected wellness days or half-days",
                "Leave of absence handling and support",
                "Parking provision or costs",
                "Housing or transportation stipend",
                "Gym membership or fitness benefits",
                "Childcare support (daycare availability, hours, costs)",
                "Lactation facilities quality and proximity",
                "Meal allowances and free meals during calls"
            ],
            "Community & Lifestyle": [
                "Urban, suburban, or rural setting",
                "Location and climate preferences",
                "Environmental quality and safety",
                "Cost of living and housing affordability",
                "Average rent for 1-bedroom apartment",
                "Ability to afford living alone vs. needing roommates",
                "Economy and employment opportunities for partners/spouses",
                "Childcare availability and schools quality",
                "Culture, entertainment, and recreation options",
                "Diversity and inclusion in community",
                "IMG-friendly environment (if applicable)",
                "Welcoming to families and LGBTQ+ residents",
                "Distance from family and support networks",
                "Commute time to hospital",
                "Public transportation access and safety",
                "Dating scene (if single)",
                "Resident social activities and traditions",
                "Community integration opportunities",
                "Religious community access (if relevant)",
                "Outdoor recreation access (trails, parks)"
            ],
            "Future Fit & Career Outcomes": [
                "Fellowship match rates and support",
                "Percentage of graduates pursuing fellowship",
                "Fellowship first-choice match rate",
                "Match rates in competitive fellowships (cardiology, GI, heme-onc)",
                "Institutions where graduates match for fellowship",
                "Primary care track availability (if applicable)",
                "Alumni locations and practice types",
                "Research and community service opportunities",
                "Alignment with career goals (hospitalist vs. subspecialist vs. primary care)",
                "In-house fellowship programs and recruitment",
                "Subspecialty elective availability in areas of interest",
                "Ability to do away 'audition' rotations",
                "Access to subspecialty faculty mentors from PGY-1",
                "Fellowship advising infrastructure",
                "ERAS and interview support for fellowship applications",
                "Job search support for hospitalist/primary care",
                "CV building and interview skills training",
                "Networking opportunities with alumni"
            ],
            "Research & Scholarship": [
                "Research track availability with dedicated pathway",
                "Protected research time (elective months available)",
                "Ability to concentrate research time (3+ months consecutively)",
                "Research-active faculty in areas of interest",
                "NIH research ranking of department",
                "T32 training grants or KL2 awards available",
                "Statistical support and data analysis resources",
                "IRB support and navigation assistance",
                "Mandatory vs. optional research for graduation",
                "Quality improvement project expectations",
                "Presentation requirements (local, regional, national)",
                "Publication expectations and support",
                "Conference travel funding",
                "Number of residents publishing annually",
                "Percentage presenting at national conferences",
                "Resident research day or symposium",
                "Advanced degree opportunities (MPH, MS, certificates)"
            ],
            "Diversity, Equity & Inclusion": [
                "Percentage of residents from underrepresented backgrounds",
                "Women in leadership positions",
                "IMG representation and support systems",
                "LGBTQ+ friendly environment and resources",
                "Faculty diversity (visible role models)",
                "Active DEI committee with resident involvement",
                "Dedicated DEI didactic sessions",
                "Health equity curriculum and electives",
                "Bias reduction training workshops",
                "Cultural humility training",
                "Health advocacy training",
                "Language and cultural competency training",
                "Holistic review in resident recruitment",
                "Anti-discrimination and anti-harassment policies",
                "Response system for discrimination incidents",
                "Psychological safety in learning environment",
                "Climate surveys and action on results"
            ],
            "Interview Day & Overall Impressions": [
                "Interview day organization and professionalism",
                "Punctuality and respect for your schedule",
                "Clarity of program presentation",
                "Responsiveness to questions",
                "Access to current residents (multiple, varied PGY levels)",
                "Resident openness and honesty",
                "Residents appearing happy and energetic",
                "Residents showing camaraderie and support",
                "Quality of facilities tour",
                "Overall gut feeling about fit and thriving potential",
                "Sense of welcome and being valued",
                "Alignment with your values and learning style",
                "Comparison to other programs visited",
                "Strengths observed during interview",
                "Weaknesses or concerns identified",
                "Follow-up communication quality"
            ],
            "Red Flags & Warning Signs": [
                "Disorganized interview day with poor planning",
                "Limited or no access to current residents",
                "Residents seeming scripted or afraid to speak honestly",
                "Dismissive or condescending faculty behavior",
                "Defensive responses to reasonable questions",
                "Evasive answers about program challenges",
                "Low board pass rates (consistently <90%)",
                "High attrition rate (>3% for IM)",
                "Recent ACGME citations without clear resolution",
                "Recent program director change without explanation",
                "High faculty turnover",
                "No structured procedure training program",
                "Vague curriculum description",
                "Unable to share fellowship match data",
                "Residents appearing exhausted or burned out",
                "Culture normalizing duty hour violations",
                "No wellness program or only generic statements",
                "Few residents with outside activities or interests",
                "Lack of diversity without clear DEI efforts",
                "Reports of malignant culture on forums",
                "Program on ACGME probation",
                "Unclear or evasive about salary and benefits",
                "Below living wage for location",
                "Inadequate parental leave policies"
            ]
        };

        // Global state management
        let scores = {}; // Stores scores. Key format: "Category|||Item"
        let selectedItems = new Set(); // Stores keys of selected items
        let filterActive = false; // Tracks if "Hide Unselected" is active

        const COPYRIGHT_TEXT = "© 2025 DocBray Foundation. All rights reserved.";

        function showToast(message, isError = false) {
            const toast = document.getElementById('toast');
            toast.textContent = message;
            toast.className = 'toast show' + (isError ? ' error' : '');
            setTimeout(() => {
                toast.className = 'toast';
            }, 3000);
        }

        // --- Initialization ---

        function initializeChecklist() {
            const panel = document.getElementById('checklistPanel');
            panel.innerHTML = ''; // Clear existing content
            scores = {}; // Reset scores object
            selectedItems.clear(); // Reset selections
            let totalItems = 0;

            Object.keys(checklistData).forEach((category, index) => {
                const items = checklistData[category];
                totalItems += items.length;

                const categoryDiv = document.createElement('div');
                categoryDiv.className = 'category';
                
                // Generate HTML for items
                categoryDiv.innerHTML = `
                    <div class="category-header" onclick="toggleCategory('category-${index}')">
                        <h3 class="category-title">${category}</h3>
                        <div style="display: flex; align-items: center; gap: 10px;">
                            <span class="category-count">${items.length} items</span>
                            <span class="toggle-icon" id="icon-category-${index}">▼</span>
                        </div>
                    </div>
                    <div class="category-items" id="category-${index}">
                        ${items.map((item, itemIndex) => {
                            const itemId = `item-${index}-${itemIndex}`;
                            // Escape single quotes for the JavaScript key string
                            const escapedItem = item.replace(/'/g, "\\'");
                            const key = `${category}|||${escapedItem}`;
                            // Initialize score as null (unscored)
                            scores[key] = null; 
                            
                            // Note: Rating container starts disabled and unscored as checkboxes are unchecked by default
                            return `
                            <div class="checklist-item" id="wrapper-${itemId}">
                                <input type="checkbox" id="checkbox-${itemId}" 
                                       onchange="handleSelectionChange('${key}', '${itemId}', this.checked)">
                                <label class="item-label" for="checkbox-${itemId}">${item}</label>
                                <div class="rating-container unscored disabled" id="container-${itemId}">
                                    <div class="slider-container">
                                        <input type="range" min="1" max="5" value="3" class="rating-slider" id="slider-${itemId}"
                                               oninput="handleSliderChange('${key}', '${itemId}')">
                                    </div>
                                    <input type="text" value="--" inputmode="numeric" class="rating-input" id="input-${itemId}"
                                           onfocus="handleInputFocus('${key}', '${itemId}')"
                                           onchange="handleInputChange('${key}', '${itemId}')"
                                           onkeydown="handleInputKeydown(event, '${itemId}')">
                                </div>
                            </div>
                        `}).join('')}
                    </div>
                `;
                panel.appendChild(categoryDiv);
            });

            document.getElementById('totalCount').textContent = totalItems;
            updateSummary();
            updateFilterClasses();
        }

        function toggleCategory(categoryId) {
            const items = document.getElementById(categoryId);
            const icon = document.getElementById('icon-' + categoryId);
            
            items.classList.toggle('collapsed');
            icon.classList.toggle('collapsed');
        }

        // --- Selection Handlers (Restored and Integrated) ---

        // Handles checkbox changes
        function handleSelectionChange(key, itemId, isChecked) {
            const ratingContainer = document.getElementById(`container-${itemId}`);
            
            if (isChecked) {
                selectedItems.add(key);
                // Enable rating controls
                ratingContainer.classList.remove('disabled');
            } else {
                selectedItems.delete(key);
                // Disable rating controls and reset score for this item when deselected
                ratingContainer.classList.add('disabled');
                // Reset score only if it was previously scored
                if (scores[key] !== null) {
                    updateScore(key, null, itemId);
                }
            }
            
            updateSummary();
            updateFilterClasses();
        }

        // Updates CSS classes for filtering visualization
        function updateFilterClasses() {
            // Update selected class on all checklist items
            document.querySelectorAll('.checklist-item').forEach(item => {
                const checkbox = item.querySelector('input[type="checkbox"]');
                if (checkbox && checkbox.checked) {
                    item.classList.add('selected');
                } else {
                    item.classList.remove('selected');
                }
            });

            // Update has-selected class on categories
            document.querySelectorAll('.category').forEach(category => {
                const hasSelected = category.querySelector('.checklist-item.selected');
                if (hasSelected) {
                    category.classList.add('has-selected');
                } else {
                    category.classList.remove('has-selected');
                }
            });
        }

        function toggleFilter() {
            filterActive = !filterActive;
            const container = document.querySelector('.container');
            const btn = document.getElementById('filterBtn');
            
            if (filterActive) {
                container.classList.add('filter-active');
                btn.textContent = '👁️ Show All';
                // Swap button styles when active
                btn.classList.remove('btn-warning');
                btn.classList.add('btn-primary');
                showToast('📌 Showing only selected criteria');
            } else {
                container.classList.remove('filter-active');
                btn.textContent = '👁️ Hide Unselected';
                btn.classList.remove('btn-primary');
                btn.classList.add('btn-warning');
                showToast('👁️ Showing all criteria');
            }
        }

        // Helper function to trigger selection updates programmatically (for buttons)
        function programmaticSelect(criteriaList = null, selectAll = false) {
            // We need to iterate over the DOM elements because the buttons rely on the text labels
            document.querySelectorAll('input[type="checkbox"]').forEach(checkbox => {
                const itemId = checkbox.id.replace('checkbox-', '');
                const labelElement = document.querySelector(`label[for="checkbox-${itemId}"]`);
                const labelText = labelElement.textContent;

                let shouldBeChecked = selectAll;
                if (criteriaList) {
                    // If a list is provided, check if the current label is in the list
                    shouldBeChecked = criteriaList.includes(labelText);
                }
                
                // Only dispatch event if the state actually changes
                if (checkbox.checked !== shouldBeChecked) {
                    checkbox.checked = shouldBeChecked;
                    
                    // We must manually construct the key to call handleSelectionChange
                    // Find the category by looking at the DOM structure
                    const categoryElement = checkbox.closest('.category');
                    const categoryTitle = categoryElement.querySelector('.category-title').textContent;
                    const escapedItem = labelText.replace(/'/g, "\\'");
                    const key = `${categoryTitle}|||${escapedItem}`;

                    handleSelectionChange(key, itemId, shouldBeChecked);
                }
            });
            // Summary and filter classes are updated within the loop/handler for accuracy
        }

        function selectAll() {
            programmaticSelect(null, true);
            showToast('✅ All criteria selected');
        }

        function deselectAll() {
            programmaticSelect([], false); // Pass empty array and false to deselect all
            showToast('✅ All criteria deselected');
        }

        function selectTop25() {
            const top25Factors = [
                "Overall curriculum quality and structure",
                "Board certification pass rates for graduates (>80% ACGME minimum; >90% excellent)",
                "Conference quality (morning report, noon conference, grand rounds)",
                "Point-of-care ultrasound (POCUS) training",
                "Protected time for conferences and education",
                "Faculty availability and approachability",
                "Clinical and teaching skills of faculty",
                "Attending rounds frequency (2-3x weekly minimum on inpatient)",
                "Primary training site reputation",
                "EMR system consistency across sites (Epic, Cerner, etc.)",
                "Resident morale and happiness",
                "Would residents choose program again?",
                "Collaborative vs. competitive environment",
                "Resident retention rate (>98% excellent for IM)",
                "Actual work hours vs. stated policy (<80 hours/week)",
                "Call schedule type (night float, 24-hour, hybrid)",
                "Post-call policies (time off after overnight)",
                "Salary for PGY-1, PGY-2, PGY-3",
                "Parental leave duration (6+ weeks minimum; 12+ ideal)",
                "Moonlighting permitted (internal and/or external)",
                "Urban, suburban, or rural setting",
                "Cost of living and housing affordability",
                "Fellowship match rates and support",
                "Alignment with career goals (hospitalist vs. subspecialist vs. primary care)",
                "Overall gut feeling about fit and thriving potential"
            ];
            programmaticSelect(top25Factors);
            showToast('✅ Selected 25 most common criteria');
        }

        function selectTopTen() {
            const topTenFactors = [
                "Resident morale and happiness",
                "Urban, suburban, or rural setting",
                "Fellowship match rates and support",
                "Board certification pass rates for graduates (>80% ACGME minimum; >90% excellent)",
                "Salary for PGY-1, PGY-2, PGY-3",
                "Actual work hours vs. stated policy (<80 hours/week)",
                "Faculty availability and approachability",
                "Overall curriculum quality and structure",
                "Primary training site reputation",
                "Overall gut feeling about fit and thriving potential"
            ];
            programmaticSelect(topTenFactors);
            showToast('✅ Selected 10 essential criteria');
        }

        // --- Scoring Handlers ---

        // When user focuses the input field (activating the rating)
        function handleInputFocus(key, itemId) {
            const container = document.getElementById(`container-${itemId}`);
            const input = document.getElementById(`input-${itemId}`);
            
            // Ensure item is selected before allowing scoring (safety check, UI should prevent this via 'disabled')
            if (!selectedItems.has(key)) return;

            if (container.classList.contains('unscored')) {
                // Activate rating: default to 3 (Average)
                updateScore(key, 3, itemId);
                // Ensure the input reflects the new value when focused for typing
                input.value = 3;
            }
            // Select the text so user can immediately type over it
            input.select();
        }

        // When user interacts with the slider
        function handleSliderChange(key, itemId) {
            if (!selectedItems.has(key)) return;
            const slider = document.getElementById(`slider-${itemId}`);
            const score = parseInt(slider.value);
            updateScore(key, score, itemId);
        }

        // When user manually types into the input field
        function handleInputChange(key, itemId) {
            if (!selectedItems.has(key)) return;
            const input = document.getElementById(`input-${itemId}`);
            let value = input.value.trim();

            if (value === "" || value === "--") {
                // Reset to unscored
                updateScore(key, null, itemId);
                return;
            }

            let score = parseInt(value);

            if (isNaN(score) || score < 1 || score > 5) {
                // Invalid input, revert to previous valid score or unscored if none
                const previousScore = scores[key];
                updateScore(key, previousScore, itemId);
                if (value !== "") {
                     showToast('⚠️ Please enter a number between 1 and 5.', true);
                }
            } else {
                // Valid input
                updateScore(key, score, itemId);
            }
        }

        // Prevent invalid keystrokes and handle Enter key behavior
        function handleInputKeydown(event, itemId) {
            // Allow control keys
            if (event.key === 'Backspace' || event.key === 'Delete' || event.key.startsWith('Arrow') || event.key === 'Tab') {
                return;
            }

            // Handle Enter key
            if (event.key === 'Enter') {
                document.getElementById(`input-${itemId}`).blur(); 
                event.preventDefault();
                return;
            }
            
            // Allow only numbers 1 through 5
            if (!/^[1-5]$/.test(event.key)) {
                event.preventDefault();
            }
        }

        // Central function to update the score in memory and UI
        function updateScore(key, score, itemId) {
            const container = document.getElementById(`container-${itemId}`);
            const input = document.getElementById(`input-${itemId}`);
            const slider = document.getElementById(`slider-${itemId}`);

            // Prevent updating score if the elements don't exist (e.g., during rapid reset)
            if (!container || !input || !slider) return;

            scores[key] = score;

            if (score === null) {
                // Unscored state
                container.classList.add('unscored');
                input.value = "--";
                slider.value = 3; // Reset slider position
            } else {
                // Scored state
                container.classList.remove('unscored');
                input.value = score;
                slider.value = score;
            }

            updateSummary();
        }

        // Update the summative score display (Updated logic for selection integration)
        function updateSummary() {
            let totalScore = 0;
            let scoredCount = 0;
            let selectedCount = selectedItems.size;

            // Iterate over selected items and check if they have a score
            selectedItems.forEach(key => {
                 if (scores[key] !== null && scores[key] !== undefined) {
                    totalScore += scores[key];
                    scoredCount++;
                }
            });

            document.getElementById('summativeScore').textContent = totalScore;
            document.getElementById('scoredCount').textContent = scoredCount;
            document.getElementById('selectedCount').textContent = selectedCount;
        }
        
        // Reset the entire form
        function resetForm() {
            if (confirm("Are you sure you want to reset the form? All selections, scores, details, and comments will be cleared.")) {
                document.getElementById('programName').value = "";
                document.getElementById('narrativeComments').value = "";
                
                // Reset date
                setDefaultDate();
                
                // If filter is active, deactivate it before resetting
                if (filterActive) {
                    toggleFilter();
                }

                initializeChecklist(); // Re-initializes everything
                showToast('✅ Form reset successfully!');
            }
        }

        // --- Data Retrieval for Export (Updated logic for selection integration) ---
        function getExportData() {
            const programName = document.getElementById('programName').value.trim() || "[Not Specified]";
            const interviewDate = document.getElementById('interviewDate').value || "[Not Specified]";
            const narrativeComments = document.getElementById('narrativeComments').value.trim();
            const summativeScore = document.getElementById('summativeScore').textContent;
            const scoredCount = document.getElementById('scoredCount').textContent;
            const selectedCount = document.getElementById('selectedCount').textContent;
            const totalCount = document.getElementById('totalCount').textContent;


            const itemsByCategory = {};

            // Iterate through the original data structure to maintain order, but only include selected items
             Object.keys(checklistData).forEach(category => {
                checklistData[category].forEach(item => {
                    const escapedItem = item.replace(/'/g, "\\'");
                    const key = `${category}|||${escapedItem}`;
                    
                    if (selectedItems.has(key)) {
                        // Initialize category array if it doesn't exist yet
                        if (!itemsByCategory[category]) {
                            itemsByCategory[category] = [];
                        }

                        const score = scores[key];
                        itemsByCategory[category].push({
                            item: item, // Use original item text for export
                            score: score // Keep as number or null
                        });
                    }
                });
            });

            return {
                programName,
                interviewDate,
                narrativeComments,
                summativeScore,
                scoredCount,
                selectedCount,
                totalCount,
                itemsByCategory
            };
        }
        
        // --- Export Functions ---

        function exportToExcel() {
            if (selectedItems.size === 0) {
                showToast('⚠️ Please select at least one criterion before exporting.', true);
                return;
            }

            if (typeof XLSX === 'undefined') {
                showToast('❌ Excel library not loaded. Please refresh.', true);
                return;
            }

            try {
                const btn = document.getElementById('excelBtn');
                btn.disabled = true;
                btn.textContent = '⏳ Generating...';

                const data = getExportData();
                const wsData = [];

                // Header Info
                wsData.push(['Internal Medicine Residency Program Evaluation']);
                wsData.push(['Program Name:', data.programName]);
                wsData.push(['Interview Date:', data.interviewDate]);
                wsData.push(['Generated Date:', new Date().toLocaleDateString()]);
                wsData.push([]);

                // Scores Header
                wsData.push(['Category', 'Criteria', 'Score (1-5)']);
                
                const dataStartRow = wsData.length + 1; // 1-based index for Excel formulas

                // Add criteria and scores (data is already filtered by selection)
                Object.keys(data.itemsByCategory).forEach(category => {
                    data.itemsByCategory[category].forEach(entry => {
                        const row = [
                            category, 
                            entry.item, 
                            entry.score !== null ? entry.score : 'Unscored'
                        ];
                        wsData.push(row);
                    });
                });

                const dataEndRow = wsData.length;

                // Summary
                wsData.push([]);
                wsData.push(['Summary']);
                wsData.push(['Total Criteria Available:', data.totalCount]);
                wsData.push(['Criteria Selected:', data.selectedCount]);
                wsData.push(['Criteria Rated:', data.scoredCount]);
                // Use formula for Summative Score in Excel, ignoring 'Unscored' text entries
                const formula = `SUMIF(C${dataStartRow}:C${dataEndRow}, "<>Unscored")`;
                wsData.push(['Summative Score:', { f: formula }]);
                wsData.push([]);

                // Narrative Comments
                wsData.push(['Narrative Comments (First 24h Reactions)']);
                wsData.push([data.narrativeComments || 'No comments entered.']);
                wsData.push([]);

                // Footer/Copyright
                wsData.push([COPYRIGHT_TEXT]);
                wsData.push(['Rating Scale: 1=Poor, 2=Below Average, 3=Average, 4=Good, 5=Excellent']);


                // Create workbook and worksheet
                const wb = XLSX.utils.book_new();
                const ws = XLSX.utils.aoa_to_sheet(wsData);

                // Set column widths
                ws['!cols'] = [
                    { wch: 35 },  // Category/Info Labels
                    { wch: 75 },  // Criteria/Details
                    { wch: 15 }   // Score
                ];

                // Add worksheet to workbook
                XLSX.utils.book_append_sheet(wb, ws, 'Program Evaluation');

                // Generate filename
                const filename = `Evaluation_${data.programName.replace(/[^a-z0-9]/gi, '_')}_${new Date().toISOString().split('T')[0]}.xlsx`;
                
                // Save file
                XLSX.writeFile(wb, filename);

                showToast('✅ Excel file downloaded successfully!');
                
            } catch (error) {
                console.error('Excel export error:', error);
                showToast('❌ Export failed: ' + error.message, true);
            } finally {
                const btn = document.getElementById('excelBtn');
                if (btn) {
                    btn.disabled = false;
                    btn.textContent = '📊 Export to Excel';
                }
            }
        }

        function exportToCSV() {
             if (selectedItems.size === 0) {
                showToast('⚠️ Please select at least one criterion before exporting.', true);
                return;
            }

            try {
                const btn = document.getElementById('csvBtn');
                btn.disabled = true;
                btn.textContent = '⏳ Generating...';

                const data = getExportData();
                let csvContent = "";

                // Function to escape CSV fields
                const escapeCSV = (field) => {
                    if (field === null || field === undefined) return '""';
                    return `"${String(field).replace(/"/g, '""')}"`;
                };

                // Header Info
                csvContent += `${escapeCSV("Program Name")},${escapeCSV(data.programName)}\n`;
                csvContent += `${escapeCSV("Interview Date")},${escapeCSV(data.interviewDate)}\n`;
                csvContent += `${escapeCSV("Generated Date")},${escapeCSV(new Date().toLocaleDateString())}\n\n`;

                // Summary
                csvContent += `${escapeCSV("Summative Score")},${escapeCSV(data.summativeScore)}\n`;
                csvContent += `${escapeCSV("Criteria Rated/Selected")},${escapeCSV(data.scoredCount)}/${escapeCSV(data.selectedCount)}\n\n`;
                
                // Scores Header
                csvContent += `${escapeCSV("Category")},${escapeCSV("Criteria")},${escapeCSV("Score (1-5)")}\n`;

                // Add criteria and scores (data is already filtered by selection)
                Object.keys(data.itemsByCategory).forEach(category => {
                    data.itemsByCategory[category].forEach(entry => {
                        const scoreText = entry.score !== null ? entry.score : 'Unscored';
                        csvContent += `${escapeCSV(category)},${escapeCSV(entry.item)},${escapeCSV(scoreText)}\n`;
                    });
                });

                // Narrative Comments
                csvContent += `\n${escapeCSV("Narrative Comments (First 24h Reactions)")}\n`;
                csvContent += `${escapeCSV(data.narrativeComments || 'No comments entered.')}\n\n`;

                // Footer/Copyright
                csvContent += `${escapeCSV(COPYRIGHT_TEXT)}\n`;
                csvContent += `${escapeCSV("Rating Scale: 1=Poor, 2=Below Average, 3=Average, 4=Good, 5=Excellent")}\n`;

                const BOM = "\uFEFF";
                const blob = new Blob([BOM + csvContent], { type: 'text/csv;charset=utf-8;' });
                const filename = `Evaluation_${data.programName.replace(/[^a-z0-9]/gi, '_')}_${new Date().toISOString().split('T')[0]}.csv`;
                
                const url = URL.createObjectURL(blob);
                const link = document.createElement('a');
                link.href = url;
                link.download = filename;
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
                URL.revokeObjectURL(url);

                showToast('✅ CSV downloaded successfully!');
                
            } catch (error) {
                console.error('CSV export error:', error);
                showToast('❌ Export failed: ' + error.message, true);
            } finally {
                const btn = document.getElementById('csvBtn');
                if (btn) {
                    btn.disabled = false;
                    btn.textContent = '📄 Export to CSV';
                }
            }
        }

        function exportToPDF() {
            if (selectedItems.size === 0) {
                showToast('⚠️ Please select at least one criterion before exporting.', true);
                return;
            }

            if (typeof window.jspdf === 'undefined') {
                showToast('❌ PDF library not loaded. Please refresh.', true);
                return;
            }

            try {
                const btn = document.getElementById('pdfBtn');
                btn.disabled = true;
                btn.textContent = '⏳ Generating...';

                const { jsPDF } = window.jspdf;
                const doc = new jsPDF();
                const data = getExportData();

                let yPosition = 20;
                const pageHeight = doc.internal.pageSize.height;
                const pageWidth = doc.internal.pageSize.width;
                const margin = 15;
                const contentWidth = pageWidth - (margin * 2);
                const criteriaWidth = contentWidth * 0.85;
                const scoreX = margin + criteriaWidth + 5;

                // Function to add footer to every page
                const addFooter = () => {
                    const pageCount = doc.internal.getNumberOfPages();
                    doc.setFontSize(8);
                    doc.setTextColor(100, 100, 100);
                    for (let i = 1; i <= pageCount; i++) {
                        doc.setPage(i);
                        doc.text(COPYRIGHT_TEXT, margin, pageHeight - 10);
                        doc.text(`Page ${i} of ${pageCount}`, pageWidth - margin, pageHeight - 10, { align: 'right' });
                    }
                };

                // Title
                doc.setFontSize(18);
                doc.setTextColor(42, 82, 152); // Blue
                doc.text('Internal Medicine Residency Evaluation', pageWidth / 2, yPosition, { align: 'center' });
                yPosition += 10;
                
                // Program Details
                doc.setFontSize(14);
                doc.setTextColor(0, 0, 0);
                doc.setFont(undefined, 'bold');
                // Handle potentially long program names
                const splitName = doc.splitTextToSize(data.programName, contentWidth);
                doc.text(splitName, pageWidth / 2, yPosition, { align: 'center' });
                yPosition += splitName.length * 7;

                doc.setFontSize(10);
                doc.setTextColor(100, 100, 100);
                doc.setFont(undefined, 'normal');
                doc.text(`Interview Date: ${data.interviewDate} | Generated: ${new Date().toLocaleDateString()}`, pageWidth / 2, yPosition, { align: 'center' });
                yPosition += 15;

                // Summary Box
                doc.setFillColor(240, 248, 255); // Light blue fill
                doc.rect(margin, yPosition, contentWidth, 25, 'F');
                doc.setDrawColor(42, 82, 152); // Blue border
                doc.setLineWidth(0.5);
                doc.rect(margin, yPosition, contentWidth, 25);
                
                yPosition += 8;
                doc.setFontSize(11);
                doc.setTextColor(42, 82, 152);
                doc.setFont(undefined, 'bold');
                doc.text('Summative Score:', margin + 5, yPosition);
                
                doc.setFontSize(16);
                // Using a slightly darker green for PDF visibility
                doc.setTextColor(34, 139, 34); 
                doc.text(data.summativeScore, margin + 45, yPosition + 1);

                yPosition += 8;
                doc.setFontSize(10);
                doc.setTextColor(0, 0, 0);
                doc.setFont(undefined, 'normal');
                doc.text(`Criteria Rated: ${data.scoredCount} / ${data.selectedCount} (Selected)`, margin + 5, yPosition);
                
                yPosition += 15;

                // Rating Scale Info
                doc.setFontSize(8);
                doc.setTextColor(150, 150, 150);
                doc.text('Rating Scale: 1=Poor | 2=Below Avg | 3=Average | 4=Good | 5=Excellent', margin, yPosition);
                yPosition += 8;

                // Table Headers
                doc.setFontSize(10);
                doc.setTextColor(0, 0, 0);
                doc.setFont(undefined, 'bold');
                doc.text('Criteria', margin, yPosition);
                doc.text('Score', scoreX, yPosition);
                yPosition += 2;
                doc.setDrawColor(0, 0, 0);
                doc.line(margin, yPosition, pageWidth - margin, yPosition);
                yPosition += 6;

                // Categories and Scores (data is already filtered by selection)
                doc.setFont(undefined, 'normal');
                
                Object.keys(data.itemsByCategory).forEach(category => {
                    // Check page height before adding category header
                    if (yPosition > pageHeight - 30) {
                        doc.addPage();
                        yPosition = 20;
                    }

                    doc.setFontSize(11);
                    // Using a darker cyan for PDF
                    doc.setTextColor(0, 139, 139); 
                    doc.setFont(undefined, 'bold');
                    doc.text(category, margin, yPosition);
                    yPosition += 7;

                    doc.setFontSize(9);
                    doc.setTextColor(0, 0, 0);
                    doc.setFont(undefined, 'normal');
                    
                    data.itemsByCategory[category].forEach(entry => {
                        const splitText = doc.splitTextToSize(entry.item, criteriaWidth - 5);
                        const requiredHeight = splitText.length * 5 + 3;

                        // Check page height before adding item
                        if (yPosition + requiredHeight > pageHeight - 20) {
                            doc.addPage();
                            yPosition = 20;
                        }

                        doc.text(splitText, margin + 3, yPosition);
                        
                        const scoreText = entry.score !== null ? String(entry.score) : 'Unscored';
                        if (entry.score !== null) {
                            doc.setTextColor(34, 139, 34); // Green for scores
                            doc.setFont(undefined, 'bold');
                        } else {
                            doc.setTextColor(150, 150, 150); // Grey for unscored
                            doc.setFont(undefined, 'italic');
                        }
                        
                        doc.text(scoreText, scoreX, yPosition);
                        
                        // Reset styles for next item text
                        doc.setTextColor(0, 0, 0);
                        doc.setFont(undefined, 'normal');

                        yPosition += requiredHeight;
                    });
                    yPosition += 3;
                });

                 // Check page height before Narrative Comments
                 if (yPosition > pageHeight - 50) {
                    doc.addPage();
                    yPosition = 20;
                }

                // Narrative Comments
                yPosition += 10;
                doc.setFontSize(12);
                // Using a darker yellow/gold for PDF
                doc.setTextColor(218, 165, 32); 
                doc.setFont(undefined, 'bold');
                doc.text('Narrative Comments (First 24h Reactions)', margin, yPosition);
                yPosition += 7;

                doc.setFontSize(10);
                doc.setTextColor(0, 0, 0);
                doc.setFont(undefined, 'normal');
                
                const comments = data.narrativeComments || 'No comments entered.';
                const splitComments = doc.splitTextToSize(comments, contentWidth);
                
                // Handle long comments spanning multiple pages
                for (const line of splitComments) {
                    if (yPosition > pageHeight - 20) {
                        doc.addPage();
                        yPosition = 20;
                    }
                    doc.text(line, margin, yPosition);
                    yPosition += 6;
                }

                addFooter();

                const filename = `Evaluation_${data.programName.replace(/[^a-z0-9]/gi, '_')}_${new Date().toISOString().split('T')[0]}.pdf`;
                doc.save(filename);

                showToast('✅ PDF downloaded successfully!');
                
            } catch (error) {
                console.error('PDF export error:', error);
                showToast('❌ Export failed: ' + error.message, true);
            } finally {
                const btn = document.getElementById('pdfBtn');
                if (btn) {
                    btn.disabled = false;
                    btn.textContent = '📑 Save as PDF';
                }
            }
        }

        function setDefaultDate() {
            // Set default date to today for convenience, respecting user's timezone
            const today = new Date();
            const offset = today.getTimezoneOffset();
            const localDate = new Date(today.getTime() - (offset*60*1000));
            const dateInput = document.getElementById('interviewDate');
             // Check if the date input element supports the 'date' type and set the value
            if (dateInput && dateInput.type === 'date') {
                 dateInput.value = localDate.toISOString().split('T')[0];
            }
        }

        // Initialize on load
        window.onload = function() {
            initializeChecklist();
            setDefaultDate();
            console.log('IM Residency Evaluation & Selection Tool Initialized');
        };
    </script>
</body>
</html>