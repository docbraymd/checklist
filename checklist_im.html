<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>IM Residency Program Evaluation & Selection 2025-2026</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <style>
        /* --- Base Styles & Theme --- */
        :root {
            --bg-main: #1a1a2e;
            --bg-secondary: #16213e;
            --bg-container: #0f0f1e;
            --bg-element: #252535;
            --bg-element-hover: #2a2a40;
            --text-primary: #e0e0e0;
            --text-secondary: #b0b0b0;
            --accent-blue: #00d9ff;
            --accent-yellow: #ffd93b;
            --accent-green: #00ff88;
            --border-color: #2a5298;
            --border-ui: #2a2a3e;
            /* Rating Colors */
            --rating-1: #ff4d4d; /* Red */
            --rating-2: #ff8c00; /* Orange */
            --rating-3: #ffcc00; /* Yellow */
            --rating-4: #9acd32; /* YellowGreen */
            --rating-5: #4caf50; /* Green */
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, var(--bg-main) 0%, var(--bg-secondary) 100%);
            color: var(--text-primary);
            line-height: 1.6;
            padding: 20px;
            min-height: 100vh;
            /* Padding top to ensure content doesn't hide behind the fixed score header */
            padding-top: 80px; 
        }

        .container {
            max-width: 1300px;
            margin: 0 auto;
            background: var(--bg-container);
            border-radius: 15px;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.5);
            overflow: hidden;
        }

        /* --- Header --- */
        .header {
            background: linear-gradient(135deg, #1e3a5f 0%, var(--border-color) 100%);
            padding: 30px;
            text-align: center;
            border-bottom: 3px solid var(--accent-blue);
        }

        .header h1 {
            color: var(--accent-blue);
            font-size: 2.5em;
            margin-bottom: 10px;
            text-shadow: 0 0 20px rgba(0, 217, 255, 0.5);
        }

        .header p {
            color: var(--text-secondary);
            font-size: 1.1em;
        }

        /* --- Program Details Input --- */
        .program-details {
            background: var(--bg-main);
            padding: 20px 30px;
            display: flex;
            gap: 20px;
            flex-wrap: wrap;
            justify-content: center;
            border-bottom: 2px solid var(--border-ui);
        }

        .input-group {
            display: flex;
            flex-direction: column;
            gap: 5px;
        }

        .input-group label {
            color: var(--accent-blue);
            font-weight: 600;
        }

        .input-group input {
            padding: 10px 15px;
            border-radius: 8px;
            border: 1px solid var(--border-color);
            background: var(--bg-container);
            color: var(--text-primary);
            font-size: 1em;
            min-width: 250px;
        }

        .input-group input:focus {
            outline: none;
            border-color: var(--accent-blue);
            box-shadow: 0 0 10px rgba(0, 217, 255, 0.3);
        }

        /* --- Info Box & Rating Guide --- */
        .info-box {
            background: var(--bg-element);
            padding: 20px;
            margin: 20px 30px;
            border-radius: 10px;
            border-left: 4px solid var(--accent-yellow);
        }

        .info-box h3 {
            color: var(--accent-yellow);
            margin-bottom: 10px;
        }

        .info-box p {
            color: var(--text-secondary);
            font-size: 0.95em;
            margin-bottom: 8px;
        }

        .rating-guide {
            display: inline-flex;
            gap: 10px;
            margin-top: 10px;
            flex-wrap: wrap;
        }

        .rating-guide span {
            padding: 5px 12px;
            border-radius: 5px;
            font-size: 0.85em;
            color: #fff;
            font-weight: bold;
        }
        .rg-1 { background: var(--rating-1); }
        .rg-2 { background: var(--rating-2); }
        .rg-3 { background: var(--rating-3); color: #333; }
        .rg-4 { background: var(--rating-4); }
        .rg-5 { background: var(--rating-5); }


        /* --- Controls & Buttons --- */
        .controls {
            background: var(--bg-main);
            padding: 20px 30px;
            display: flex;
            gap: 15px;
            flex-wrap: wrap;
            justify-content: center;
            align-items: center;
        }

        .controls.top-controls {
            border-bottom: 2px solid var(--border-ui);
        }

        .controls.bottom-controls {
            border-top: 2px solid var(--border-ui);
        }


        .btn {
            padding: 12px 20px;
            border: none;
            border-radius: 8px;
            font-size: 0.9em;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            text-transform: uppercase;
            letter-spacing: 1px;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.3);
        }

        .btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none !important;
        }

        /* Button Gradients */
        .btn-primary { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: #ffffff; }
        .btn-primary:hover:not(:disabled) { background: linear-gradient(135deg, #764ba2 0%, #667eea 100%); transform: translateY(-2px); box-shadow: 0 8px 25px rgba(102, 126, 234, 0.5); }
        .btn-primary.top-ten { background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%); }
        .btn-primary.top-ten:hover:not(:disabled) { background: linear-gradient(135deg, #f5576c 0%, #f093fb 100%); box-shadow: 0 8px 25px rgba(245, 87, 108, 0.5); }
        .btn-success { background: linear-gradient(135deg, #11998e 0%, #38ef7d 100%); color: #ffffff; }
        .btn-success:hover:not(:disabled) { background: linear-gradient(135deg, #38ef7d 0%, #11998e 100%); transform: translateY(-2px); box-shadow: 0 8px 25px rgba(56, 239, 125, 0.5); }
        .btn-warning { background: linear-gradient(135deg, #fc6c8f 0%, #ffb88c 100%); color: #ffffff; }
        .btn-warning:hover:not(:disabled) { background: linear-gradient(135deg, #ffb88c 0%, #fc6c8f 100%); transform: translateY(-2px); box-shadow: 0 8px 25px rgba(252, 108, 143, 0.5); }
        .btn-success.excel { background: linear-gradient(135deg, #1e7e34 0%, #28a745 100%); }
        .btn-success.excel:hover:not(:disabled) { background: linear-gradient(135deg, #28a745 0%, #1e7e34 100%); box-shadow: 0 8px 25px rgba(40, 167, 69, 0.5); }
        .btn-success.csv { background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%); }
        .btn-success.csv:hover:not(:disabled) { background: linear-gradient(135deg, #00f2fe 0%, #4facfe 100%); box-shadow: 0 8px 25px rgba(79, 172, 254, 0.5); }
        .btn-warning.pdf { background: linear-gradient(135deg, #fa709a 0%, #fee140 100%); }
        .btn-warning.pdf:hover:not(:disabled) { background: linear-gradient(135deg, #fee140 0%, #fa709a 100%); box-shadow: 0 8px 25px rgba(254, 225, 64, 0.5); }
        .btn-danger { background: linear-gradient(135deg, #eb3349 0%, #f45c43 100%); color: #ffffff; }
        .btn-danger:hover:not(:disabled) { background: linear-gradient(135deg, #f45c43 0%, #eb3349 100%); transform: translateY(-2px); box-shadow: 0 8px 25px rgba(235, 51, 73, 0.5); }

        /* --- Content & Categories --- */
        .content { padding: 30px; }
        .category { margin-bottom: 30px; background: var(--bg-main); border-radius: 10px; padding: 20px; border-left: 4px solid var(--accent-blue); transition: all 0.3s ease; }
        .category:hover { background: #1e1e2e; box-shadow: 0 5px 20px rgba(0, 217, 255, 0.1); }
        .category-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; cursor: pointer; padding: 10px; border-radius: 8px; transition: background 0.3s ease; }
        .category-header:hover { background: var(--bg-element); }
        .category-title { font-size: 1.4em; font-weight: 700; color: var(--accent-blue); text-shadow: 0 0 10px rgba(0, 217, 255, 0.3); }
        .category-count { background: var(--accent-blue); color: var(--bg-container); padding: 4px 12px; border-radius: 20px; font-size: 0.9em; font-weight: 600; }
        .category-items { display: block; }
        .category-items.collapsed { display: none; }
        .toggle-icon { font-size: 1.2em; transition: transform 0.3s ease; }
        .toggle-icon.collapsed { transform: rotate(-90deg); }

        /* --- Checklist Item, Selection & Rating Controls (Updated for Responsiveness) --- */
        .checklist-item {
            display: flex;
            align-items: center;
            padding: 15px;
            background: var(--bg-element);
            border-radius: 6px;
            margin-bottom: 10px;
            transition: all 0.2s ease;
        }

        .checklist-item:hover {
            background: var(--bg-element-hover);
        }

        /* Container for checkbox and label */
        .item-selection-container {
            display: flex;
            align-items: center;
            flex: 1;
        }

        /* Selection Checkbox */
        .checklist-item input[type="checkbox"] {
            margin-right: 15px;
            width: 20px;
            height: 20px;
            cursor: pointer;
            accent-color: var(--accent-blue);
            flex-shrink: 0;
        }

        .item-label {
            flex: 1;
            color: #d0d0d0;
            font-size: 0.95em;
            cursor: pointer;
        }

        /* Visual feedback for selected items */
        .checklist-item.selected {
            background: #2a3a4a;
            border-left: 3px solid var(--accent-green);
        }

        .checklist-item.selected .item-label {
             color: var(--accent-green);
             font-weight: 500;
        }

        /* Rating Controls */
        .rating-container {
            display: flex;
            align-items: center;
            gap: 15px;
            flex-shrink: 0;
        }

        /* Style for disabled rating container (when checkbox is unchecked) */
        .rating-container.disabled {
            opacity: 0.4;
            pointer-events: none;
        }

        .slider-container {
            width: 150px; /* Increased width slightly for better desktop usability */
            transition: opacity 0.3s ease;
        }

        /* The slider is now always visible if enabled (no longer hidden by 'unscored' class) */

        .rating-slider {
            width: 100%;
            cursor: pointer;
            /* Accent color is dynamically controlled by JavaScript */
        }

        .rating-input {
            width: 60px;
            padding: 8px;
            text-align: center;
            border-radius: 5px;
            border: 1px solid var(--border-color);
            background: var(--bg-container);
            color: var(--text-primary);
            font-size: 1em;
            cursor: text; /* Cursor is always text now as activation is handled by checkbox */
        }

        /* Style for unscored input (applies when deselected) */
        .rating-container.unscored .rating-input {
            color: #7a7a8e;
            font-style: italic;
            border-color: var(--border-color);
        }
        
        /* Style for scored input */
        .rating-container:not(.unscored) .rating-input {
            color: var(--accent-green);
            font-weight: bold;
            border-color: var(--accent-green);
        }

        .rating-input:focus {
            outline: none;
            border-color: var(--accent-blue);
            box-shadow: 0 0 5px rgba(0, 217, 255, 0.5);
        }

        /* --- Responsive Design Adjustments (Mobile Layout) --- */
        @media (max-width: 768px) {
            body {
                padding: 0;
                padding-top: 80px;
            }
            .container {
                border-radius: 0;
            }

            .header h1 {
                font-size: 1.8em;
            }

            .content, .info-box, .narrative-section {
                margin-left: 15px;
                margin-right: 15px;
                padding: 15px;
            }
            
            .controls, .program-details {
                 padding: 15px;
            }

            /* Hide the number input box on small screens */
            .rating-input {
                display: none;
            }

            /* Adjust layout for checklist items */
            .checklist-item {
                /* Change from flex-row (default) to column layout */
                flex-direction: column;
                align-items: flex-start;
                padding: 15px 10px;
            }

            .item-selection-container {
                width: 100%; /* Ensure the label/checkbox take full width */
            }

            .item-label {
                padding-right: 0;
            }

            /* Move the rating container below the label */
            .rating-container {
                width: 100%;
                margin-top: 12px;
                padding-left: 35px; /* Indent slightly to align with text */
            }

            .slider-container {
                width: 100%; /* Make the slider take the available width */
            }
        }


        /* --- Filtering --- */
        .filter-active .checklist-item:not(.selected) { display: none; }
        .filter-active .category:not(.has-selected) { display: none; }

        /* --- Sticky Score Display --- */
        .sticky-score-header {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            background: var(--bg-main);
            padding: 15px 30px;
            box-shadow: 0 5px 20px rgba(0, 0, 0, 0.6);
            z-index: 100;
            display: flex;
            justify-content: center;
            align-items: center;
            border-bottom: 2px solid var(--accent-blue);
        }

        .score-display {
            font-size: 1.2em;
            color: var(--text-secondary);
        }

        .score-value {
            color: var(--accent-green);
            font-size: 1.4em;
            font-weight: 700;
            margin-left: 10px;
            text-shadow: 0 0 10px rgba(0, 255, 136, 0.5);
        }

        .score-details {
            font-size: 0.8em;
            color: #9a9aae;
            margin-left: 15px;
        }

        @media (max-width: 768px) {
             .sticky-score-header {
                padding: 10px 15px;
            }
            .score-display {
                font-size: 1em;
                text-align: center;
            }
             .score-details {
                display: block;
                margin-left: 0;
                margin-top: 5px;
                text-align: center;
            }
        }

        /* --- Narrative Comments & Footer --- */
        .narrative-section { padding: 30px; background: var(--bg-main); margin: 0 30px 30px 30px; border-radius: 10px; border-left: 4px solid var(--accent-yellow); }
        .narrative-section h3 { color: var(--accent-yellow); margin-bottom: 10px; }
        .narrative-section p { color: var(--text-secondary); font-size: 0.9em; margin-bottom: 15px; }
        #narrativeComments { width: 100%; min-height: 150px; padding: 15px; border-radius: 8px; border: 1px solid var(--border-color); background: var(--bg-container); color: var(--text-primary); font-size: 1em; resize: vertical; }
        #narrativeComments:focus { outline: none; border-color: var(--accent-blue); box-shadow: 0 0 10px rgba(0, 217, 255, 0.3); }
        .footer { text-align: center; padding: 20px; background: var(--bg-container); color: #7a7a8e; font-size: 0.9em; border-top: 1px solid var(--border-ui); }

        /* --- Utilities & Misc --- */
        ::-webkit-scrollbar { width: 10px; height: 10px; }
        ::-webkit-scrollbar-track { background: var(--bg-main); }
        ::-webkit-scrollbar-thumb { background: var(--accent-blue); border-radius: 5px; }
        ::-webkit-scrollbar-thumb:hover { background: #00fff2; }
        .toast { position: fixed; bottom: 30px; right: 30px; background: linear-gradient(135deg, #51cf66 0%, #37b24d 100%); color: white; padding: 15px 25px; border-radius: 10px; box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3); transform: translateY(150%); transition: transform 0.3s ease; z-index: 1000; font-weight: 600; }
        .toast.show { transform: translateY(0); }
        .toast.error { background: linear-gradient(135deg, #ff6b6b 0%, #fa5252 100%); }
    </style>
</head>
<body>
    <div class="sticky-score-header">
        <div class="score-display">
            Score Ratio: <span class="score-value" id="scoreRatio">0.00</span>
            <span class="score-details">(<span id="totalScore">0</span> pts / <span id="maxPossibleScore">0</span> max pts)</span>
        </div>
    </div>

    <div class="container">
        <div class="header">
            <h1>üè• Internal Medicine Residency Program Evaluation</h1>
            <p>2025-2026 Application Cycle ‚Ä¢ Criteria Selection & Post-Interview Assessment</p>
        </div>

        <div class="program-details">
            <div class="input-group">
                <label for="programName">Program Name</label>
                <input type="text" id="programName" placeholder="e.g., University Hospital IM">
            </div>
            <div class="input-group">
                <label for="interviewDate">Interview Date</label>
                <input type="date" id="interviewDate">
            </div>
        </div>

        <div class="info-box">
            <h3>üìù How to Use This Tool</h3>
             <p><strong>1. Select Criteria:</strong> Check the boxes for criteria important to YOU. Selected items default to 3 (Average).</p>
            <p><strong>2. Rate Program:</strong> Adjust the slider (or use the number input on desktop) to rate the program.</p>
             <p><strong>3. Export & Compare:</strong> Export to Excel/CSV to generate a comparison matrix for up to 15 programs.</p>
            <div class="rating-guide">
                <span class="rg-1">1 = Poor</span>
                <span class="rg-2">2 = Below Avg</span>
                <span class="rg-3">3 = Average</span>
                <span class="rg-4">4 = Good</span>
                <span class="rg-5">5 = Excellent</span>
            </div>
        </div>

        <div class="controls top-controls">
            <button class="btn btn-primary" onclick="selectTop25()">‚≠ê Top 25</button>
            <button class="btn btn-primary top-ten" onclick="selectTopTen()">‚ö° Top 10</button>
            <button class="btn btn-success" onclick="selectAll()">‚úì Select All</button>
            <button class="btn btn-danger" onclick="deselectAll()">‚úó Deselect All</button>
            <button class="btn btn-warning" onclick="toggleFilter()" id="filterBtn">üëÅÔ∏è Hide Unselected</button>
        </div>

        <div class="content">
            <div id="checklistPanel"></div>
        </div>

        <div class="narrative-section">
            <h3>üí¨ Narrative Comments</h3>
            <p>Record your first memories, gut reactions, and key takeaways from the interview day (within the first 24 hours).</p>
            <textarea id="narrativeComments" placeholder="Enter your immediate thoughts and feelings here..."></textarea>
        </div>

        <div class="controls bottom-controls">
            <button class="btn btn-success excel" onclick="exportToExcel()" id="excelBtn">üìä Export (Excel)</button>
            <button class="btn btn-success csv" onclick="exportToCSV()" id="csvBtn">üìÑ Export (CSV)</button>
            <button class="btn btn-warning pdf" onclick="exportToPDF()" id="pdfBtn">üìë Export (PDF)</button>
            <button class="btn btn-danger" onclick="resetForm()">üîÑ Reset Form</button>
        </div>

        <div class="footer">
            ¬© 2025 DocBray Foundation. All rights reserved.
        </div>
    </div>

    <div id="toast" class="toast"></div>

    <script>
        // Complete dataset of criteria
        const checklistData = {
            "Education & Curriculum": [
                "Program philosophy and mission alignment",
                "ACGME accreditation status (no recent citations)",
                "Overall curriculum quality and structure",
                "Rotations and electives variety (exposure to subspecialties)",
                "Educational rounds vs. work rounds balance",
                "Conference quality (morning report, noon conference, grand rounds)",
                "Patient volume and diversity (socioeconomic, ethnic backgrounds)",
                "Library and educational resources access",
                "Resident evaluation methods (milestones, direct observation, feedback frequency)",
                "Board certification pass rates for graduates (>80% ACGME minimum; >90% excellent)",
                "Continuity clinic model (weekly vs. block vs. X+Y)",
                "Continuity clinic frequency (meets 10-month outpatient requirement)",
                "Post-call clinic policies",
                "Protected time for conferences and education",
                "MKSAP subscription and board preparation support",
                "In-Training Examination (ITE) administration and feedback",
                "Simulation-based training availability",
                "Point-of-care ultrasound (POCUS) training",
                "Procedure training structure and competency assessment"
            ],
            "Faculty & Teaching": [
                "Full-time vs. part-time faculty ratio",
                "Research vs. teaching balance among faculty",
                "Clinical and teaching skills of faculty",
                "Faculty availability and approachability",
                "Continuity clinic preceptors (longitudinal relationship)",
                "Subspecialties represented (strong in areas of interest?)",
                "Faculty involvement in patient counseling and education",
                "Attending rounds frequency (2-3x weekly minimum on inpatient)",
                "Bedside teaching vs. 'see and present' culture",
                "Faculty-to-resident ratio",
                "Faculty turnover rate",
                "Faculty development in teaching",
                "Program director accessibility and responsiveness",
                "Associate/assistant program director support",
                "Chief resident accessibility and mentorship"
            ],
            "Hospital & Facilities": [
                "Community vs. university hospital setting",
                "Staff support for program (nursing, labs, pathology, respiratory)",
                "Consultative services availability and quality",
                "Other residency programs present at training sites",
                "Patient types and disease diversity",
                "Patient socioeconomic and ethnic diversity",
                "Hospital staff quality (nursing, support services)",
                "Primary training site reputation",
                "Number of different rotation sites",
                "Distance and commute between sites",
                "VA hospital rotations (if applicable)",
                "EMR system consistency across sites (Epic, Cerner, etc.)",
                "EMR user-friendliness",
                "Telemedicine infrastructure",
                "Call room quality and cleanliness",
                "Call room privacy (individual vs. shared)",
                "Resident lounge and workspace adequacy",
                "Hospital cafeteria hours and quality",
                "Hospital gym availability and quality"
            ],
            "Residents & Program Culture": [
                "Number of residents per year",
                "Medical schools of origin (diversity)",
                "Resident personality, dependability, and honesty",
                "Cooperativeness and compatibility among residents",
                "Do residents socialize outside of work?",
                "Collaborative vs. competitive environment",
                "Support among co-residents (coverage culture)",
                "Resident morale and happiness",
                "Would residents choose program again?",
                "Resident retention rate (>98% excellent for IM)",
                "Attrition rate (<2% excellent; >3% concerning)",
                "Resident enthusiasm and energy during interview",
                "Residents appearing rested vs. exhausted",
                "Interprofessional respect (with nurses, APPs, etc.)",
                "Professionalism and mutual respect",
                "Program responsiveness to resident concerns"
            ],
            "Workload & Duty Hours": [
                "Average patients per resident (rotation and clinic)",
                "Supervision levels and attending support",
                "Call schedule type (night float, 24-hour, hybrid)",
                "Call schedule frequency (Q3, Q4, Q5, etc.)",
                "Rounds and teaching responsibilities",
                "Scut work balance (phlebotomy, transport, etc.)",
                "Time protected for conferences and clinics",
                "Progressive autonomy from PGY1 to PGY3",
                "Actual work hours vs. stated policy (<80 hours/week)",
                "Duty hour violation frequency and handling",
                "Culture around staying beyond scheduled hours",
                "Post-call policies (time off after overnight)",
                "Night float duration and frequency",
                "Post-night float recovery days",
                "Weekend coverage frequency",
                "Home call frequency and burden",
                "Ancillary support (phlebotomy, social work, respiratory therapy)"
            ],
            "Benefits & Wellness": [
                "Salary for PGY-1, PGY-2, PGY-3",
                "Professional dues, meals, and insurance coverage",
                "Health insurance quality and employee contribution",
                "Dental and vision coverage",
                "Mental health coverage quality",
                "Vacation, parental leave, maternity, sick leave policies",
                "Parental leave duration (6+ weeks minimum; 12+ ideal)",
                "Policy for birthing vs. non-birthing parents",
                "Adoption and foster care leave",
                "Conference funding and educational stipend",
                "Books and MKSAP subscription provided",
                "Moonlighting permitted (internal and/or external)",
                "Year eligible for moonlighting and pay rates",
                "Stress management support and wellness programs",
                "24/7 confidential mental health access",
                "Wellness curriculum and wellness committee",
                "Regular burnout assessment with action plans",
                "Protected wellness days or half-days",
                "Leave of absence handling and support",
                "Parking provision or costs",
                "Housing or transportation stipend",
                "Gym membership or fitness benefits",
                "Childcare support (daycare availability, hours, costs)",
                "Lactation facilities quality and proximity",
                "Meal allowances and free meals during calls"
            ],
            "Community & Lifestyle": [
                "Urban, suburban, or rural setting",
                "Location and climate preferences",
                "Environmental quality and safety",
                "Cost of living and housing affordability",
                "Average rent for 1-bedroom apartment",
                "Ability to afford living alone vs. needing roommates",
                "Economy and employment opportunities for partners/spouses",
                "Childcare availability and schools quality",
                "Culture, entertainment, and recreation options",
                "Diversity and inclusion in community",
                "IMG-friendly environment (if applicable)",
                "Welcoming to families and LGBTQ+ residents",
                "Distance from family and support networks",
                "Commute time to hospital",
                "Public transportation access and safety",
                "Dating scene (if single)",
                "Resident social activities and traditions",
                "Community integration opportunities",
                "Religious community access (if relevant)",
                "Outdoor recreation access (trails, parks)"
            ],
            "Future Fit & Career Outcomes": [
                "Fellowship match rates and support",
                "Percentage of graduates pursuing fellowship",
                "Fellowship first-choice match rate",
                "Match rates in competitive fellowships (cardiology, GI, heme-onc)",
                "Institutions where graduates match for fellowship",
                "Primary care track availability (if applicable)",
                "Alumni locations and practice types",
                "Research and community service opportunities",
                "Alignment with career goals (hospitalist vs. subspecialist vs. primary care)",
                "In-house fellowship programs and recruitment",
                "Subspecialty elective availability in areas of interest",
                "Ability to do away 'audition' rotations",
                "Access to subspecialty faculty mentors from PGY-1",
                "Fellowship advising infrastructure",
                "ERAS and interview support for fellowship applications",
                "Job search support for hospitalist/primary care",
                "CV building and interview skills training",
                "Networking opportunities with alumni"
            ],
            "Research & Scholarship": [
                "Research track availability with dedicated pathway",
                "Protected research time (elective months available)",
                "Ability to concentrate research time (3+ months consecutively)",
                "Research-active faculty in areas of interest",
                "NIH research ranking of department",
                "T32 training grants or KL2 awards available",
                "Statistical support and data analysis resources",
                "IRB support and navigation assistance",
                "Mandatory vs. optional research for graduation",
                "Quality improvement project expectations",
                "Presentation requirements (local, regional, national)",
                "Publication expectations and support",
                "Conference travel funding",
                "Number of residents publishing annually",
                "Percentage presenting at national conferences",
                "Resident research day or symposium",
                "Advanced degree opportunities (MPH, MS, certificates)"
            ],
            "Diversity, Equity & Inclusion": [
                "Percentage of residents from underrepresented backgrounds",
                "Women in leadership positions",
                "IMG representation and support systems",
                "LGBTQ+ friendly environment and resources",
                "Faculty diversity (visible role models)",
                "Active DEI committee with resident involvement",
                "Dedicated DEI didactic sessions",
                "Health equity curriculum and electives",
                "Bias reduction training workshops",
                "Cultural humility training",
                "Health advocacy training",
                "Language and cultural competency training",
                "Holistic review in resident recruitment",
                "Anti-discrimination and anti-harassment policies",
                "Response system for discrimination incidents",
                "Psychological safety in learning environment",
                "Climate surveys and action on results"
            ],
            "Interview Day & Overall Impressions": [
                "Interview day organization and professionalism",
                "Punctuality and respect for your schedule",
                "Clarity of program presentation",
                "Responsiveness to questions",
                "Access to current residents (multiple, varied PGY levels)",
                "Resident openness and honesty",
                "Residents appearing happy and energetic",
                "Residents showing camaraderie and support",
                "Quality of facilities tour",
                "Overall gut feeling about fit and thriving potential",
                "Sense of welcome and being valued",
                "Alignment with your values and learning style",
                "Comparison to other programs visited",
                "Strengths observed during interview",
                "Weaknesses or concerns identified",
                "Follow-up communication quality"
            ],
            "Red Flags & Warning Signs": [
                "Disorganized interview day with poor planning",
                "Limited or no access to current residents",
                "Residents seeming scripted or afraid to speak honestly",
                "Dismissive or condescending faculty behavior",
                "Defensive responses to reasonable questions",
                "Evasive answers about program challenges",
                "Low board pass rates (consistently <90%)",
                "High attrition rate (>3% for IM)",
                "Recent ACGME citations without clear resolution",
                "Recent program director change without explanation",
                "High faculty turnover",
                "No structured procedure training program",
                "Vague curriculum description",
                "Unable to share fellowship match data",
                "Residents appearing exhausted or burned out",
                "Culture normalizing duty hour violations",
                "No wellness program or only generic statements",
                "Few residents with outside activities or interests",
                "Lack of diversity without clear DEI efforts",
                "Reports of malignant culture on forums",
                "Program on ACGME probation",
                "Unclear or evasive about salary and benefits",
                "Below living wage for location",
                "Inadequate parental leave policies"
            ]
        };

        // Global state management
        let scores = {}; // Stores scores. Key format: "Category|||Item"
        let selectedItems = new Set(); // Stores keys of selected items
        let filterActive = false; // Tracks if "Hide Unselected" is active
        let totalItemsCount = 0; // Global count of all items

        const COPYRIGHT_TEXT = "¬© 2025 DocBray Foundation. All rights reserved.";
        const MAX_SCORE_PER_ITEM = 5;
        const MAX_PROGRAMS = 15; // Number of columns for the matrix

        function showToast(message, isError = false) {
            const toast = document.getElementById('toast');
            toast.textContent = message;
            toast.className = 'toast show' + (isError ? ' error' : '');
            setTimeout(() => {
                toast.className = 'toast';
            }, 3000);
        }

        // Helper function to get color based on score (NEW)
        function getScoreColor(score) {
            switch (score) {
                case 1: return 'var(--rating-1)';
                case 2: return 'var(--rating-2)';
                case 3: return 'var(--rating-3)';
                case 4: return 'var(--rating-4)';
                case 5: return 'var(--rating-5)';
                default: return 'var(--accent-blue)'; // Default color when unscored/deselected
            }
        }

        // --- Initialization & UI Functions ---

        function initializeChecklist() {
            const panel = document.getElementById('checklistPanel');
            panel.innerHTML = ''; // Clear existing content
            scores = {}; // Reset scores object
            selectedItems.clear(); // Reset selections
            totalItemsCount = 0; // Reset total count

            Object.keys(checklistData).forEach((category, index) => {
                const items = checklistData[category];
                totalItemsCount += items.length;

                const categoryDiv = document.createElement('div');
                categoryDiv.className = 'category';
                
                // Generate HTML for items (UPDATED structure for responsiveness)
                categoryDiv.innerHTML = `
                    <div class="category-header" onclick="toggleCategory('category-${index}')">
                        <h3 class="category-title">${category}</h3>
                        <div style="display: flex; align-items: center; gap: 10px;">
                            <span class="category-count">${items.length} items</span>
                            <span class="toggle-icon" id="icon-category-${index}">‚ñº</span>
                        </div>
                    </div>
                    <div class="category-items" id="category-${index}">
                        ${items.map((item, itemIndex) => {
                            const itemId = `item-${index}-${itemIndex}`;
                            const escapedItem = item.replace(/'/g, "\\'");
                            const key = `${category}|||${escapedItem}`;
                            scores[key] = null; 
                            
                            // Rating container starts disabled. 'unscored' class is kept for input styling consistency.
                            return `
                            <div class="checklist-item" id="wrapper-${itemId}">
                                <div class="item-selection-container">
                                    <input type="checkbox" id="checkbox-${itemId}" 
                                           onchange="handleSelectionChange('${key}', '${itemId}', this.checked)">
                                    <label class="item-label" for="checkbox-${itemId}">${item}</label>
                                </div>
                                <div class="rating-container unscored disabled" id="container-${itemId}">
                                    <div class="slider-container">
                                        <input type="range" min="1" max="${MAX_SCORE_PER_ITEM}" value="3" class="rating-slider" id="slider-${itemId}"
                                               oninput="handleSliderChange('${key}', '${itemId}')"
                                               style="accent-color: ${getScoreColor(null)}">
                                    </div>
                                    <input type="text" value="--" inputmode="numeric" class="rating-input" id="input-${itemId}"
                                           onfocus="handleInputFocus('${key}', '${itemId}')"
                                           onchange="handleInputChange('${key}', '${itemId}')"
                                           onkeydown="handleInputKeydown(event, '${itemId}')">
                                </div>
                            </div>
                        `}).join('')}
                    </div>
                `;
                panel.appendChild(categoryDiv);
            });

            updateSummary();
            updateFilterClasses();
        }

        // (toggleCategory, updateFilterClasses, toggleFilter remain the same)
        function toggleCategory(categoryId) {
            const items = document.getElementById(categoryId);
            const icon = document.getElementById('icon-' + categoryId);
            items.classList.toggle('collapsed');
            icon.classList.toggle('collapsed');
        }

        function updateFilterClasses() {
            document.querySelectorAll('.checklist-item').forEach(item => {
                const checkbox = item.querySelector('input[type="checkbox"]');
                if (checkbox && checkbox.checked) {
                    item.classList.add('selected');
                } else {
                    item.classList.remove('selected');
                }
            });
            document.querySelectorAll('.category').forEach(category => {
                const hasSelected = category.querySelector('.checklist-item.selected');
                if (hasSelected) {
                    category.classList.add('has-selected');
                } else {
                    category.classList.remove('has-selected');
                }
            });
        }

        function toggleFilter() {
            filterActive = !filterActive;
            const container = document.querySelector('.container');
            const btn = document.getElementById('filterBtn');
            if (filterActive) {
                container.classList.add('filter-active');
                btn.textContent = 'üëÅÔ∏è Show All';
                btn.classList.remove('btn-warning');
                btn.classList.add('btn-primary');
                showToast('üìå Showing only selected criteria');
            } else {
                container.classList.remove('filter-active');
                btn.textContent = 'üëÅÔ∏è Hide Unselected';
                btn.classList.remove('btn-primary');
                btn.classList.add('btn-warning');
                showToast('üëÅÔ∏è Showing all criteria');
            }
        }


        // Handles checkbox changes (UPDATED: Defaults to 3 on selection)
        function handleSelectionChange(key, itemId, isChecked) {
            const ratingContainer = document.getElementById(`container-${itemId}`);
            
            if (isChecked) {
                selectedItems.add(key);
                ratingContainer.classList.remove('disabled');

                // If the score is currently null (unscored), default it to 3 (Average)
                // This simplifies activation for both mobile and desktop.
                if (scores[key] === null) {
                    updateScore(key, 3, itemId);
                }

            } else {
                selectedItems.delete(key);
                ratingContainer.classList.add('disabled');
                // Reset score when deselected
                if (scores[key] !== null) {
                    updateScore(key, null, itemId);
                }
            }
            
            updateSummary();
            updateFilterClasses();
        }

        // Helper function to trigger selection updates programmatically (for buttons)
        function programmaticSelect(criteriaList = null, selectAll = false) {
            // We need to iterate over the DOM elements because the buttons rely on the text labels
            document.querySelectorAll('input[type="checkbox"]').forEach(checkbox => {
                const itemId = checkbox.id.replace('checkbox-', '');
                // Updated selector due to HTML structure change
                const labelElement = document.querySelector(`label[for="checkbox-${itemId}"]`);
                const labelText = labelElement.textContent;

                let shouldBeChecked = selectAll;
                if (criteriaList) {
                    // If a list is provided, check if the current label is in the list
                    shouldBeChecked = criteriaList.includes(labelText);
                }
                
                // Only dispatch event if the state actually changes
                if (checkbox.checked !== shouldBeChecked) {
                    checkbox.checked = shouldBeChecked;
                    
                    // We must manually construct the key to call handleSelectionChange
                    const categoryElement = checkbox.closest('.category');
                    const categoryTitle = categoryElement.querySelector('.category-title').textContent;
                    const escapedItem = labelText.replace(/'/g, "\\'");
                    const key = `${categoryTitle}|||${escapedItem}`;

                    handleSelectionChange(key, itemId, shouldBeChecked);
                }
            });
        }

        // (Selection Button functions remain the same)
        function selectAll() { programmaticSelect(null, true); showToast('‚úÖ All criteria selected and rated 3'); }
        function deselectAll() { programmaticSelect([], false); showToast('‚úÖ All criteria deselected'); }
        function selectTop25() {
            const top25Factors = [
                "Overall curriculum quality and structure", "Board certification pass rates for graduates (>80% ACGME minimum; >90% excellent)", "Conference quality (morning report, noon conference, grand rounds)", "Point-of-care ultrasound (POCUS) training", "Protected time for conferences and education", "Faculty availability and approachability", "Clinical and teaching skills of faculty", "Attending rounds frequency (2-3x weekly minimum on inpatient)", "Primary training site reputation", "EMR system consistency across sites (Epic, Cerner, etc.)", "Resident morale and happiness", "Would residents choose program again?", "Collaborative vs. competitive environment", "Resident retention rate (>98% excellent for IM)", "Actual work hours vs. stated policy (<80 hours/week)", "Call schedule type (night float, 24-hour, hybrid)", "Post-call policies (time off after overnight)", "Salary for PGY-1, PGY-2, PGY-3", "Parental leave duration (6+ weeks minimum; 12+ ideal)", "Moonlighting permitted (internal and/or external)", "Urban, suburban, or rural setting", "Cost of living and housing affordability", "Fellowship match rates and support", "Alignment with career goals (hospitalist vs. subspecialist vs. primary care)", "Overall gut feeling about fit and thriving potential"
            ];
            programmaticSelect(top25Factors);
            showToast('‚úÖ Selected Top 25 criteria');
        }
        function selectTopTen() {
            const topTenFactors = [
                "Resident morale and happiness", "Urban, suburban, or rural setting", "Fellowship match rates and support", "Board certification pass rates for graduates (>80% ACGME minimum; >90% excellent)", "Salary for PGY-1, PGY-2, PGY-3", "Actual work hours vs. stated policy (<80 hours/week)", "Faculty availability and approachability", "Overall curriculum quality and structure", "Primary training site reputation", "Overall gut feeling about fit and thriving potential"
            ];
            programmaticSelect(topTenFactors);
            showToast('‚úÖ Selected Top 10 criteria');
        }

        // --- Scoring Handlers ---

        // When user focuses the input field (Desktop only)
        function handleInputFocus(key, itemId) {
            const input = document.getElementById(`input-${itemId}`);
            // Ensure item is selected before allowing scoring
            if (!selectedItems.has(key)) return;
            // Select the text so user can immediately type over it
            input.select();
        }

        // When user interacts with the slider
        function handleSliderChange(key, itemId) {
            if (!selectedItems.has(key)) return;
            const slider = document.getElementById(`slider-${itemId}`);
            const score = parseInt(slider.value);
            updateScore(key, score, itemId);
        }

        // When user manually types into the input field (Desktop only)
        function handleInputChange(key, itemId) {
            if (!selectedItems.has(key)) return;
            const input = document.getElementById(`input-${itemId}`);
            let value = input.value.trim();

            // If the user clears the field on desktop, revert to default (3) instead of allowing unscored for a selected item
            if (value === "" || value === "--") {
                updateScore(key, 3, itemId);
                if (value !== "") {
                     showToast('‚ÑπÔ∏è Selected criteria must have a rating. Reset to 3 (Average).');
                }
                return;
            }

            let score = parseInt(value);

            if (isNaN(score) || score < 1 || score > MAX_SCORE_PER_ITEM) {
                // Invalid input, revert to previous valid score
                const previousScore = scores[key];
                // Ensure previous score isn't null (shouldn't happen if selected, but safe check)
                updateScore(key, previousScore !== null ? previousScore : 3, itemId);
                if (value !== "") {
                     showToast(`‚ö†Ô∏è Please enter a number between 1 and ${MAX_SCORE_PER_ITEM}.`, true);
                }
            } else {
                // Valid input
                updateScore(key, score, itemId);
            }
        }

        // (handleInputKeydown remains the same)
        function handleInputKeydown(event, itemId) {
            if (event.key === 'Backspace' || event.key === 'Delete' || event.key.startsWith('Arrow') || event.key === 'Tab') return;
            if (event.key === 'Enter') {
                document.getElementById(`input-${itemId}`).blur(); 
                event.preventDefault();
                return;
            }
            if (!/^[1-5]$/.test(event.key)) {
                event.preventDefault();
            }
        }

        // Central function to update the score (UPDATED: Includes color update)
        function updateScore(key, score, itemId) {
            const container = document.getElementById(`container-${itemId}`);
            const input = document.getElementById(`input-${itemId}`);
            const slider = document.getElementById(`slider-${itemId}`);

            // Prevent updating score if the elements don't exist
            if (!container || !input || !slider) return;

            scores[key] = score;

            if (score === null) {
                // Unscored state (occurs when deselected)
                container.classList.add('unscored');
                input.value = "--";
                slider.value = 3; // Reset slider position visually
                slider.style.accentColor = getScoreColor(null); // Reset color
            } else {
                // Scored state
                container.classList.remove('unscored');
                input.value = score;
                slider.value = score;
                // Update slider color (NEW)
                slider.style.accentColor = getScoreColor(score);
            }

            updateSummary();
        }

        // (updateSummary remains the same)
        function updateSummary() {
            let totalScoreAccumulated = 0;
            let scoredCount = 0;
            let selectedCount = selectedItems.size;

            selectedItems.forEach(key => {
                 // Since we default to 3, all selected items are considered "scored" if not null
                 if (scores[key] !== null && scores[key] !== undefined) {
                    totalScoreAccumulated += scores[key];
                    scoredCount++;
                }
            });

            const maxPossibleScore = selectedCount * MAX_SCORE_PER_ITEM;

            let scoreRatio = 0;
            if (maxPossibleScore > 0) {
                scoreRatio = totalScoreAccumulated / maxPossibleScore;
            }

            document.getElementById('scoreRatio').textContent = scoreRatio.toFixed(2);
            document.getElementById('totalScore').textContent = totalScoreAccumulated;
            document.getElementById('maxPossibleScore').textContent = maxPossibleScore;
        }
        
        // (resetForm remains the same)
        function resetForm() {
            if (confirm("Are you sure you want to reset the form? All selections, scores, details, and comments will be cleared.")) {
                document.getElementById('programName').value = "";
                document.getElementById('narrativeComments').value = "";
                setDefaultDate();
                if (filterActive) {
                    toggleFilter();
                }
                initializeChecklist();
                showToast('‚úÖ Form reset successfully!');
            }
        }

        // --- Data Retrieval for Export ---
        // (getExportData remains the same)
        function getExportData() {
            const programName = document.getElementById('programName').value.trim();
            const interviewDate = document.getElementById('interviewDate').value;
            const narrativeComments = document.getElementById('narrativeComments').value.trim();
            
            const scoreRatio = document.getElementById('scoreRatio').textContent;
            const totalScore = document.getElementById('totalScore').textContent;
            const maxPossibleScore = document.getElementById('maxPossibleScore').textContent;
            
            const itemsByCategory = {};

             Object.keys(checklistData).forEach(category => {
                checklistData[category].forEach(item => {
                    const escapedItem = item.replace(/'/g, "\\'");
                    const key = `${category}|||${escapedItem}`;
                    
                    if (selectedItems.has(key)) {
                        if (!itemsByCategory[category]) {
                            itemsByCategory[category] = [];
                        }
                        const score = scores[key];
                        itemsByCategory[category].push({
                            item: item,
                            score: score
                        });
                    }
                });
            });

            return {
                programName, interviewDate, narrativeComments, scoreRatio, totalScore, maxPossibleScore, totalCount: totalItemsCount, itemsByCategory
            };
        }
        
        // --- Export Functions (Excel, CSV, PDF) ---
        
        // (Export functions remain largely the same, but Excel/CSV logic is slightly updated because selected items are now guaranteed to have a score)

        function exportToExcel() {
            if (selectedItems.size === 0) {
                showToast('‚ö†Ô∏è Please select at least one criterion before exporting.', true);
                return;
            }

            if (typeof XLSX === 'undefined') {
                showToast('‚ùå Excel library not loaded. Please refresh.', true);
                return;
            }

            try {
                const btn = document.getElementById('excelBtn');
                btn.disabled = true;
                btn.textContent = '‚è≥ Generating...';

                const data = getExportData();
                const wsData = [];
                const generatedDate = new Date().toLocaleDateString();
                const maxPossibleScoreValue = parseInt(data.maxPossibleScore);

                // --- Header Rows (Identical) ---
                const nameRow = ['Category', 'Criteria'];
                nameRow.push(data.programName || '[Enter Program Name]');
                for (let i = 2; i <= MAX_PROGRAMS; i++) { nameRow.push(`[Enter Program ${i} Name]`); }
                wsData.push(nameRow);

                const interviewDateRow = ['Details', 'Interview Date'];
                interviewDateRow.push(data.interviewDate || '[Enter Date]');
                for (let i = 2; i <= MAX_PROGRAMS; i++) { interviewDateRow.push('[Enter Date]'); }
                wsData.push(interviewDateRow);

                const generatedDateRow = ['Details', 'Generated Date'];
                const isP1Populated = data.programName || data.interviewDate || data.narrativeComments;
                generatedDateRow.push( isP1Populated ? generatedDate : '[N/A]');
                for (let i = 2; i <= MAX_PROGRAMS; i++) { generatedDateRow.push('[N/A]'); }
                wsData.push(generatedDateRow);

                wsData.push([]);
                const dataStartRow = 5; 
                
                // --- Data Rows (Updated: No longer need 'Unscored' text) ---
                Object.keys(data.itemsByCategory).forEach(category => {
                    data.itemsByCategory[category].forEach(entry => {
                        const row = [category, entry.item];
                        
                        // Since we default to 3, score should not be null for selected items.
                        const scoreValue = entry.score !== null ? entry.score : 'Error'; // Should not happen
                        row.push(scoreValue);

                        for (let i = 2; i <= MAX_PROGRAMS; i++) {
                            row.push('');
                        }
                        wsData.push(row);
                    });
                });

                const dataEndRow = wsData.length;

                // --- Summary Rows (Updated: Use SUM instead of SUMIF) ---
                const pointsSelectedRow = ['Summary', 'Points Selected (Total)'];
                const pointsAvailableRow = ['Summary', 'Points Available (Max)'];
                const scoreRatioRow = ['Summary', 'Score Ratio (0.00-1.00)'];

                for (let i = 0; i < MAX_PROGRAMS; i++) {
                    const colLetter = String.fromCharCode(67 + i); // C=67 (ASCII)
                    
                    // Total Score Formula: SUM(Range)
                    // Since we no longer use "Unscored" text for selected items, a simple SUM works.
                    const sumFormula = `SUM(${colLetter}${dataStartRow}:${colLetter}${dataEndRow})`;
                    pointsSelectedRow.push({ f: sumFormula });

                    pointsAvailableRow.push(maxPossibleScoreValue);

                    const totalScoreRowNum = dataEndRow + 1;
                    const maxScoreRowNum = dataEndRow + 2;
                    const ratioFormula = `IFERROR(${colLetter}${totalScoreRowNum} / ${colLetter}${maxScoreRowNum}, 0)`;
                    
                    scoreRatioRow.push({ f: ratioFormula, t: 'n', z: '0.00' });
                }

                wsData.push(pointsSelectedRow);
                wsData.push(pointsAvailableRow);
                wsData.push(scoreRatioRow);

                wsData.push([]);

                // --- Narrative Comments & Footer (Identical) ---
                const commentsRow = ['Comments', 'Narrative (First 24h)'];
                commentsRow.push(data.narrativeComments || '[Enter Comments]');
                 for (let i = 2; i <= MAX_PROGRAMS; i++) { commentsRow.push('[Enter Comments]'); }
                wsData.push(commentsRow);

                wsData.push([]);
                wsData.push([COPYRIGHT_TEXT]);
                wsData.push(['Rating Scale: 1=Poor, 2=Below Average, 3=Average, 4=Good, 5=Excellent']);


                // Create workbook and worksheet
                const wb = XLSX.utils.book_new();
                const ws = XLSX.utils.aoa_to_sheet(wsData);

                // Set column widths
                const cols = [{ wch: 25 }, { wch: 55 }];
                for (let i = 0; i < MAX_PROGRAMS; i++) { cols.push({ wch: 25 }); }
                ws['!cols'] = cols;

                XLSX.utils.book_append_sheet(wb, ws, 'Program Comparison Matrix');

                // Generate filename
                const filenamePrefix = data.programName ? `Matrix_${data.programName.replace(/[^a-z0-9]/gi, '_')}_` : 'Comparison_Matrix_';
                const filename = `${filenamePrefix}${new Date().toISOString().split('T')[0]}.xlsx`;
                
                XLSX.writeFile(wb, filename);

                showToast('‚úÖ Excel Comparison Matrix downloaded!');
                
            } catch (error) {
                console.error('Excel export error:', error);
                showToast('‚ùå Export failed: ' + error.message, true);
            } finally {
                const btn = document.getElementById('excelBtn');
                if (btn) {
                    btn.disabled = false;
                    btn.textContent = 'üìä Export (Excel)';
                }
            }
        }

        function exportToCSV() {
             if (selectedItems.size === 0) {
                showToast('‚ö†Ô∏è Please select at least one criterion before exporting.', true);
                return;
            }

            try {
                const btn = document.getElementById('csvBtn');
                btn.disabled = true;
                btn.textContent = '‚è≥ Generating...';

                const data = getExportData();
                const generatedDate = new Date().toLocaleDateString();

                 const escapeCSV = (field) => {
                    if (field === null || field === undefined) return '""';
                    return `"${String(field).replace(/"/g, '""')}"`;
                };

                const createCSVRow = (arr) => arr.map(escapeCSV).join(',') + '\n';
                
                let csvContent = "";

                // --- Header Rows ---
                const nameRow = ['Category', 'Criteria'];
                nameRow.push(data.programName || '[Enter Program Name]');
                for (let i = 2; i <= MAX_PROGRAMS; i++) { nameRow.push(`[Enter Program ${i} Name]`); }
                csvContent += createCSVRow(nameRow);

                const interviewDateRow = ['Details', 'Interview Date'];
                interviewDateRow.push(data.interviewDate || '[Enter Date]');
                for (let i = 2; i <= MAX_PROGRAMS; i++) { interviewDateRow.push('[Enter Date]'); }
                csvContent += createCSVRow(interviewDateRow);

                const generatedDateRow = ['Details', 'Generated Date'];
                const isP1Populated = data.programName || data.interviewDate || data.narrativeComments;
                generatedDateRow.push( isP1Populated ? generatedDate : '[N/A]');
                for (let i = 2; i <= MAX_PROGRAMS; i++) { generatedDateRow.push('[N/A]'); }
                csvContent += createCSVRow(generatedDateRow);

                csvContent += "\n";

                // --- Data Rows (Updated: No longer need 'Unscored' text) ---
                 Object.keys(data.itemsByCategory).forEach(category => {
                    data.itemsByCategory[category].forEach(entry => {
                        const row = [category, entry.item];
                        
                        // Score should not be null
                        const scoreText = entry.score !== null ? entry.score : 'Error'; 
                        row.push(scoreText);

                        for (let i = 2; i <= MAX_PROGRAMS; i++) {
                            row.push('');
                        }
                        csvContent += createCSVRow(row);
                    });
                });

                // --- Summary Rows ---
                const pointsSelectedRow = ['Summary', 'Points Selected (Total)'];
                pointsSelectedRow.push(data.totalScore);
                for (let i = 2; i <= MAX_PROGRAMS; i++) { pointsSelectedRow.push('[Calculate Total]'); }
                csvContent += createCSVRow(pointsSelectedRow);

                const pointsAvailableRow = ['Summary', 'Points Available (Max)'];
                for (let i = 1; i <= MAX_PROGRAMS; i++) { pointsAvailableRow.push(data.maxPossibleScore); }
                csvContent += createCSVRow(pointsAvailableRow);

                const scoreRatioRow = ['Summary', 'Score Ratio (0.00-1.00)'];
                 scoreRatioRow.push(data.scoreRatio);
                 for (let i = 2; i <= MAX_PROGRAMS; i++) { scoreRatioRow.push('[Calculate Ratio]'); }
                csvContent += createCSVRow(scoreRatioRow);

                 csvContent += "\n";

                // --- Narrative Comments & Footer ---
                const commentsRow = ['Comments', 'Narrative (First 24h)'];
                commentsRow.push(data.narrativeComments || '[Enter Comments]');
                 for (let i = 2; i <= MAX_PROGRAMS; i++) { commentsRow.push('[Enter Comments]'); }
                csvContent += createCSVRow(commentsRow);

                 csvContent += "\n";
                csvContent += createCSVRow([COPYRIGHT_TEXT]);
                csvContent += createCSVRow(['Rating Scale: 1=Poor, 2=Below Average, 3=Average, 4=Good, 5=Excellent']);

                const BOM = "\uFEFF";
                const blob = new Blob([BOM + csvContent], { type: 'text/csv;charset=utf-8;' });
                
                const filenamePrefix = data.programName ? `Matrix_${data.programName.replace(/[^a-z0-9]/gi, '_')}_` : 'Comparison_Matrix_';
                const filename = `${filenamePrefix}${new Date().toISOString().split('T')[0]}.csv`;
                
                const url = URL.createObjectURL(blob);
                const link = document.createElement('a');
                link.href = url;
                link.download = filename;
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
                URL.revokeObjectURL(url);

                showToast('‚úÖ CSV Comparison Matrix downloaded!');
                
            } catch (error) {
                console.error('CSV export error:', error);
                showToast('‚ùå Export failed: ' + error.message, true);
            } finally {
                const btn = document.getElementById('csvBtn');
                if (btn) {
                    btn.disabled = false;
                    btn.textContent = 'üìÑ Export (CSV)';
                }
            }
        }

        function exportToPDF() {
            if (selectedItems.size === 0) {
                showToast('‚ö†Ô∏è Please select at least one criterion before exporting.', true);
                return;
            }

            if (typeof window.jspdf === 'undefined') {
                showToast('‚ùå PDF library not loaded. Please refresh.', true);
                return;
            }
           
            try {
                const btn = document.getElementById('pdfBtn');
                btn.disabled = true;
                btn.textContent = '‚è≥ Generating...';

                const { jsPDF } = window.jspdf;
                const doc = new jsPDF();
                const data = getExportData();

                const displayName = data.programName || "[Not Specified]";
                const displayDate = data.interviewDate || "[Not Specified]";


                let yPosition = 20;
                const pageHeight = doc.internal.pageSize.height;
                const pageWidth = doc.internal.pageSize.width;
                const margin = 15;
                const contentWidth = pageWidth - (margin * 2);
                const criteriaWidth = contentWidth * 0.85;
                const scoreX = margin + criteriaWidth + 5;

                const addFooter = () => {
                    const pageCount = doc.internal.getNumberOfPages();
                    doc.setFontSize(8);
                    doc.setTextColor(100, 100, 100);
                    for (let i = 1; i <= pageCount; i++) {
                        doc.setPage(i);
                        doc.text(COPYRIGHT_TEXT, margin, pageHeight - 10);
                        doc.text(`Page ${i} of ${pageCount}`, pageWidth - margin, pageHeight - 10, { align: 'right' });
                    }
                };

                // Title & Details (Identical)
                doc.setFontSize(18);
                doc.setTextColor(42, 82, 152); // Blue
                doc.text('Internal Medicine Residency Evaluation Report', pageWidth / 2, yPosition, { align: 'center' });
                yPosition += 10;
                
                doc.setFontSize(14);
                doc.setTextColor(0, 0, 0);
                doc.setFont(undefined, 'bold');
                const splitName = doc.splitTextToSize(displayName, contentWidth);
                doc.text(splitName, pageWidth / 2, yPosition, { align: 'center' });
                yPosition += splitName.length * 7;

                doc.setFontSize(10);
                doc.setTextColor(100, 100, 100);
                doc.setFont(undefined, 'normal');
                doc.text(`Interview Date: ${displayDate} | Generated: ${new Date().toLocaleDateString()}`, pageWidth / 2, yPosition, { align: 'center' });
                yPosition += 15;

                // Summary Box
                const summaryBoxHeight = 30;
                doc.setFillColor(240, 248, 255);
                doc.rect(margin, yPosition, contentWidth, summaryBoxHeight, 'F');
                doc.setDrawColor(42, 82, 152);
                doc.setLineWidth(0.5);
                doc.rect(margin, yPosition, contentWidth, summaryBoxHeight);
                
                yPosition += 9;
                doc.setFontSize(12);
                doc.setTextColor(42, 82, 152);
                doc.setFont(undefined, 'bold');
                doc.text('Score Ratio (0.00-1.00):', margin + 5, yPosition);
                
                doc.setFontSize(18);
                doc.setTextColor(34, 139, 34); 
                doc.text(data.scoreRatio, margin + 65, yPosition + 1);

                yPosition += 9;
                doc.setFontSize(10);
                doc.setTextColor(0, 0, 0);
                doc.setFont(undefined, 'normal');
                doc.text(`Total Points: ${data.totalScore} / ${data.maxPossibleScore} (Max Possible)`, margin + 5, yPosition);
                
                yPosition += 7;
                const selectedCount = selectedItems.size;
                doc.text(`Criteria Selected: ${selectedCount}`, margin + 5, yPosition);


                yPosition += 15;

                // Rating Scale Info & Table Headers (Identical)
                doc.setFontSize(8);
                doc.setTextColor(150, 150, 150);
                doc.text('Rating Scale: 1=Poor | 2=Below Avg | 3=Average | 4=Good | 5=Excellent', margin, yPosition);
                yPosition += 8;

                doc.setFontSize(10);
                doc.setTextColor(0, 0, 0);
                doc.setFont(undefined, 'bold');
                doc.text('Criteria', margin, yPosition);
                doc.text('Score', scoreX, yPosition);
                yPosition += 2;
                doc.setDrawColor(0, 0, 0);
                doc.line(margin, yPosition, pageWidth - margin, yPosition);
                yPosition += 6;

                // Categories and Scores (Updated: Score should not be null)
                doc.setFont(undefined, 'normal');
                
                Object.keys(data.itemsByCategory).forEach(category => {
                    if (yPosition > pageHeight - 30) {
                        doc.addPage();
                        yPosition = 20;
                    }

                    doc.setFontSize(11);
                    doc.setTextColor(0, 139, 139); 
                    doc.setFont(undefined, 'bold');
                    doc.text(category, margin, yPosition);
                    yPosition += 7;

                    doc.setFontSize(9);
                    doc.setTextColor(0, 0, 0);
                    doc.setFont(undefined, 'normal');
                    
                    data.itemsByCategory[category].forEach(entry => {
                        const splitText = doc.splitTextToSize(entry.item, criteriaWidth - 5);
                        const requiredHeight = splitText.length * 5 + 3;

                        if (yPosition + requiredHeight > pageHeight - 20) {
                            doc.addPage();
                            yPosition = 20;
                        }

                        doc.text(splitText, margin + 3, yPosition);
                        
                        // Score should not be null for selected items
                        const scoreText = entry.score !== null ? String(entry.score) : 'Error';
                        
                        doc.setTextColor(34, 139, 34); // Green (Using standard green for PDF scores)
                        doc.setFont(undefined, 'bold');
                       
                        doc.text(scoreText, scoreX, yPosition);
                        
                        doc.setTextColor(0, 0, 0);
                        doc.setFont(undefined, 'normal');

                        yPosition += requiredHeight;
                    });
                    yPosition += 3;
                });

                 if (yPosition > pageHeight - 50) {
                    doc.addPage();
                    yPosition = 20;
                }

                // Narrative Comments & Footer (Identical)
                yPosition += 10;
                doc.setFontSize(12);
                doc.setTextColor(218, 165, 32); 
                doc.setFont(undefined, 'bold');
                doc.text('Narrative Comments (First 24h Reactions)', margin, yPosition);
                yPosition += 7;

                doc.setFontSize(10);
                doc.setTextColor(0, 0, 0);
                doc.setFont(undefined, 'normal');
                
                const comments = data.narrativeComments || 'No comments entered.';
                const splitComments = doc.splitTextToSize(comments, contentWidth);
                
                for (const line of splitComments) {
                    if (yPosition > pageHeight - 20) {
                        doc.addPage();
                        yPosition = 20;
                    }
                    doc.text(line, margin, yPosition);
                    yPosition += 6;
                }

                addFooter();
                
                const filenamePrefix = data.programName ? `Report_${data.programName.replace(/[^a-z0-9]/gi, '_')}_` : 'Report_';
                const filename = `${filenamePrefix}${new Date().toISOString().split('T')[0]}.pdf`;
                doc.save(filename);

                showToast('‚úÖ PDF Report downloaded successfully!');
                
            } catch (error) {
                console.error('PDF export error:', error);
                showToast('‚ùå Export failed: ' + error.message, true);
            } finally {
                const btn = document.getElementById('pdfBtn');
                if (btn) {
                    btn.disabled = false;
                    btn.textContent = 'üìë Export (PDF)';
                }
            }
        }


        function setDefaultDate() {
            // Set default date to today for convenience.
            const today = new Date();
            const offset = today.getTimezoneOffset();
            
            if (isNaN(offset)) {
                 // Handle rare cases where timezone offset cannot be determined
                 return;
            }

            try {
                // Adjust for timezone offset to ensure the correct local date is displayed in the input field
                const localDate = new Date(today.getTime() - (offset*60*1000));
                const dateInput = document.getElementById('interviewDate');
                
                if (dateInput && dateInput.type === 'date') {
                    // Format to YYYY-MM-DD
                    dateInput.value = localDate.toISOString().split('T')[0];
                }
            } catch (e) {
                console.error("Error setting default date:", e);
            }
        }

        // Initialize on load
        window.onload = function() {
            initializeChecklist();
            setDefaultDate();
            console.log('IM Residency Evaluation & Selection Tool Initialized');
        };
    </script>
</body>
</html>
